var V=Object.defineProperty;var $=(l,e,t)=>e in l?V(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var S=(l,e,t)=>$(l,typeof e!="symbol"?e+"":e,t);import{d as j,s as q,x as Y,q as H,c as W,a as p,b,t as I,F as X,l as Z,e as J,f as z,A as Q,B as tt,p as D,z as et,C as st,g as nt,o as O,n as at,_ as ot}from"./index-Dje41XHH.js";import{u as rt}from"./MapRenderer-xkhg8OLD.js";import{u as it,a as lt,b as ct,G as dt,S as ut,c as mt}from"./ShopModal-DUf5KCSU.js";const ht=300,ft=3250,pt=1400,C=800,E={usp:{id:"usp",name:"USP-S",damage:35,magazineSize:12,fireRateMs:150,reloadTimeMs:2200,range:600,spread:.02},ak47:{id:"ak47",name:"AK-47",damage:36,magazineSize:30,fireRateMs:100,reloadTimeMs:2500,range:690,spread:.04,price:2700},m4:{id:"m4",name:"M4A1",damage:33,magazineSize:30,fireRateMs:90,reloadTimeMs:3100,range:690,spread:.03,price:3100}},vt={ct:"usp"};function yt(l,e,t,n,a,s,r,i){const d=(l-t)*(s-i)-(e-n)*(a-r);if(Math.abs(d)<1e-10)return null;const o=((l-a)*(s-i)-(e-s)*(a-r))/d,c=-((l-t)*(e-s)-(e-n)*(l-a))/d;return o>=0&&o<=1&&c>=0&&c<=1?{x:l+o*(t-l),y:e+o*(n-e),t:o}:null}function wt(l,e,t,n,a,s){const r=a-t,i=s-n,d=r*r+i*i;if(d===0)return{dist:Math.hypot(l-t,e-n),t:0};let o=((l-t)*r+(e-n)*i)/d;o=Math.max(0,Math.min(1,o));const c=t+o*r,f=n+o*i;return{dist:Math.hypot(l-c,e-f),t:o}}function gt(l,e,t,n,a,s){const r=l+t*a,i=e+n*a;let d=1;for(const o of s){const c=[[o.x,o.y,o.x+o.width,o.y],[o.x+o.width,o.y,o.x+o.width,o.y+o.height],[o.x+o.width,o.y+o.height,o.x,o.y+o.height],[o.x,o.y+o.height,o.x,o.y]];for(const[f,h,u,m]of c){const y=yt(l,e,r,i,f,h,u,m);y&&y.t<d&&(d=y.t)}}return d*a}function Mt(l,e,t,n,a,s,r,i){const d=(Math.random()-.5)*a*Math.PI,o=Math.cos(t+d),c=Math.sin(t+d),f=gt(l,e,o,c,n,s);let h=null;const u=l+o*n,m=e+c*n;for(const y of r){if(y.id===i)continue;const{dist:A,t:v}=wt(y.x,y.y,l,e,u,m);if(A>y.radius)continue;const x=v*n-Math.sqrt(Math.max(0,y.radius*y.radius-A*A));x<0||x>f||(!h||x<h.dist)&&(h={hitId:y.id,dist:x})}return h}const L=25,St=3e4,At=45e3,xt=1;function Tt(l,e,t,n=40){for(const a of t){const s=a.x-n,r=a.y-n,i=a.width+n*2,d=a.height+n*2;if(l>=s&&l<=s+i&&e>=r&&e<=r+d)return!0}return!1}function Rt(l,e,t){for(let n=0;n<50;n++){const a=80+Math.random()*(l-160),s=80+Math.random()*(e-160);if(!Tt(a,s,t))return{x:a,y:s}}return{x:l/2,y:e/2}}function _t(l,e){const t=[],n=new Set,a=s=>{const r=Rt(l.width,l.height,l.walls),i=`${Math.floor(r.x/50)}_${Math.floor(r.y/50)}`;n.has(i)||(n.add(i),t.push({id:`pickup_${t.length}`,type:s,x:r.x,y:r.y,respawnAt:0}))};for(let s=0;s<e.ammo;s++)a("ammo");for(let s=0;s<e.medkit;s++)a("medkit");return t}function kt(l,e,t,n){var a;for(const s of l)if(!(s.respawnAt>n))for(const r of e){if(!r.isAlive)continue;const i=r.x-s.x,d=r.y-s.y;if(!(i*i+d*d>L*L)){if(s.type==="ammo"){const o=t(r.weapon)??30;r.ammoReserve+=o*xt,(a=r.weaponAmmo)!=null&&a[r.weapon]&&(r.weaponAmmo[r.weapon].reserve=r.ammoReserve)}else s.type==="medkit"&&(r.health=Math.min(100,r.health+20));s.respawnAt=n+(s.type==="ammo"?St:At);break}}}function It(l,e){return l.filter(t=>t.respawnAt<=e).map(t=>({id:t.id,type:t.type,x:t.x,y:t.y}))}const B=["Bot Ivan","Bot Dmitry","Bot Alex","Bot Sergei"];function Et(l){return B[l%B.length]}function Pt(l,e,t,n,a,s=2e3){const r=t-l,i=n-e,d=Math.hypot(r,i);if(d>s)return!1;const o=d>0?r/d:0,c=d>0?i/d:0,f=l+o*d,h=e+c*d;for(const u of a){const m=[[u.x,u.y,u.x+u.width,u.y],[u.x+u.width,u.y,u.x+u.width,u.y+u.height],[u.x+u.width,u.y+u.height,u.x,u.y+u.height],[u.x,u.y+u.height,u.x,u.y]];for(const[y,A,v,T]of m){const x=(l-f)*(A-T)-(e-h)*(y-v);if(Math.abs(x)<1e-10)continue;const R=((y-l)*(A-T)-(A-e)*(y-v))/x,_=-((l-f)*(A-e)-(e-h)*(y-l))/x;if(R>=0&&R<=1&&_>=0&&_<=1)return!1}}return!0}function Dt(l,e){let t=e-l;for(;t>Math.PI;)t-=2*Math.PI;for(;t<-Math.PI;)t+=2*Math.PI;return t}function Wt(l,e,t,n,a,s,r,i){const d=s.filter(v=>v.team!==e&&v.isAlive),o=.6,c=.15,f=.5;let h=null,u=1/0;for(const v of d){const T=Math.hypot(v.x-t,v.y-n);T<u&&Pt(t,n,v.x,v.y,r)&&(u=T,h=v)}const m={up:!1,down:!1,left:!1,right:!1};let y=a,A=!1;if(h&&Math.random()<o){const v=Math.atan2(h.y-n,h.x-t),T=(Math.random()-.5)*2*c*Math.PI;if(y=v+T,Math.abs(Dt(a,y))<.15&&(A=!0),u>250&&Math.random()<f){const R=v,_=Math.cos(R),P=Math.sin(R);_>.3?m.right=!0:_<-.3&&(m.left=!0),P>.3?m.down=!0:P<-.3&&(m.up=!0)}else if(u<150&&Math.random()<.5){const R=Math.atan2(n-h.y,t-h.x),_=Math.cos(R),P=Math.sin(R);_>.3?m.right=!0:_<-.3&&(m.left=!0),P>.3?m.down=!0:P<-.3&&(m.up=!0)}}else if(i%60<30&&Math.random()<.1){const v=Math.floor(Math.random()*4);v===0?m.up=!0:v===1?m.down=!0:v===2?m.left=!0:m.right=!0}return{input:m,angle:y,shoot:A}}const U=20,bt=1e3/U,Ot=23,N=180*1e3,zt=5e3,Ct=2;class Lt{constructor(e){S(this,"map");S(this,"players",new Map);S(this,"pickups",[]);S(this,"tickInterval",null);S(this,"tickCount",0);S(this,"round",1);S(this,"roundStartTime",0);S(this,"roundWins",{ct:0,t:0});S(this,"roundPhase","playing");S(this,"roundEndAt",0);S(this,"onState");S(this,"onShotTrail");S(this,"onShot");S(this,"onRoundEnd");this.map=e}start(){const e={ct:[...this.map.spawnPoints.ct],t:[...this.map.spawnPoints.t]};let t=0,n=0;const a=vt.ct,s=E[a],r=e.ct[0]||{x:100,y:100};this.players.set("local",{id:"local",team:"ct",username:"You",x:r.x+30,y:r.y+30,angle:0,vx:0,vy:0,health:100,weapon:a,ammo:s.magazineSize,ammoReserve:24,isAlive:!0,kills:0,deaths:0,credits:C,weapons:[null,a],currentSlot:1,weaponAmmo:{},lastInput:{up:!1,down:!1,left:!1,right:!1},lastShotTime:0,reloadEndTime:0});for(let i=0;i<Ct;i++){const d=i===0?"t":"ct",o=d==="ct"?e.ct:e.t,c=d==="ct"?t++:n++,f=o[c%o.length]||{x:100,y:100},h=`bot-${i}`,u=E[a];this.players.set(h,{id:h,team:d,username:Et(i),x:f.x+30,y:f.y+30,angle:0,vx:0,vy:0,health:100,weapon:a,ammo:u.magazineSize,ammoReserve:24,isAlive:!0,kills:0,deaths:0,credits:C,weapons:[null,a],currentSlot:1,weaponAmmo:{},lastInput:{up:!1,down:!1,left:!1,right:!1},lastShotTime:0,reloadEndTime:0})}this.pickups=_t(this.map,{ammo:5,medkit:3}),this.roundStartTime=Date.now(),this.tickInterval=setInterval(()=>this.tick(),bt)}setOnState(e){this.onState=e}setOnShotTrail(e){this.onShotTrail=e}setOnShot(e){this.onShot=e}setOnRoundEnd(e){this.onRoundEnd=e}setInput(e,t){const n=this.players.get(e);n&&(n.lastInput=t)}setAngle(e,t){const n=this.players.get(e);n&&(n.angle=t)}shoot(e){var h,u;const t=this.players.get(e);if(!t||!t.isAlive)return;const n=Date.now(),a=E[t.weapon];if(!a||t.reloadEndTime>n)return;if(t.ammo<=0){this.startReload(t);return}if(n-t.lastShotTime<a.fireRateMs)return;t.lastShotTime=n,t.ammo--,t.weaponAmmo[t.weapon]={ammo:t.ammo,reserve:t.ammoReserve};const s=(Math.random()-.5)*a.spread*Math.PI,r=t.angle+s,i=Array.from(this.players.values()).filter(m=>m.isAlive).map(m=>({id:m.id,team:m.team,x:m.x,y:m.y,radius:Ot})),d=Mt(t.x,t.y,r,a.range,0,this.map.walls,i,e),o=d?d.dist:a.range,c=t.x+Math.cos(r)*o,f=t.y+Math.sin(r)*o;if((h=this.onShotTrail)==null||h.call(this,t.x,t.y,c,f),(u=this.onShot)==null||u.call(this,t.weapon),d){const m=this.players.get(d.hitId);m&&m.team!==t.team&&(m.health=Math.max(0,m.health-a.damage),m.health<=0&&(m.isAlive=!1,m.deaths++,t.kills++,t.credits+=ht))}}reload(e){const t=this.players.get(e);if(!t||!t.isAlive||t.ammoReserve<=0)return;const n=E[t.weapon];!n||t.ammo>=n.magazineSize||Date.now()<t.reloadEndTime||this.startReload(t)}startReload(e){const t=E[e.weapon];!t||t.reloadTimeMs<=0||(e.reloadEndTime=Date.now()+t.reloadTimeMs)}switchWeapon(e,t){const n=this.players.get(e);!n||!n.isAlive||!n.weapons[t]&&t===0||t!==n.currentSlot&&(n.weaponAmmo[n.weapon]={ammo:n.ammo,reserve:n.ammoReserve},n.currentSlot=t,this.applyWeaponSlot(n))}buyWeapon(e,t){const n=this.players.get(e);if(!n||!n.isAlive)return;const a=E[t];if(!(!a||!a.price)&&!(n.credits<a.price)&&(t==="ak47"||t==="m4")){if(n.weapons[0])return;n.credits-=a.price,n.weapons[0]=t,n.weaponAmmo[t]={ammo:a.magazineSize,reserve:0},n.weaponAmmo[n.weapon]={ammo:n.ammo,reserve:n.ammoReserve},n.currentSlot=0,this.applyWeaponSlot(n)}}applyWeaponSlot(e){const t=e.weapons[e.currentSlot];e.weapon=t??e.weapons[1];const n=E[e.weapon];if(!n)return;const a=e.weaponAmmo[e.weapon];a?(e.ammo=a.ammo,e.ammoReserve=a.reserve):(e.ammo=n.magazineSize,e.ammoReserve=e.weapon==="usp"?24:90)}respawnAll(){const e={ct:[...this.map.spawnPoints.ct],t:[...this.map.spawnPoints.t]};let t=0,n=0;for(const a of this.players.values()){const s=a.team==="ct"?e.ct:e.t,r=a.team==="ct"?t++:n++,i=s[r%s.length]||{x:100,y:100};a.x=i.x+30,a.y=i.y+30,a.vx=0,a.vy=0,a.health=100,a.isAlive=!0,a.reloadEndTime=0,this.applyWeaponSlot(a)}}checkRoundEnd(e){var r;if(this.roundPhase==="ended"){e>=this.roundEndAt&&(this.round++,this.roundPhase="playing",this.roundStartTime=e,this.respawnAll());return}const t=Array.from(this.players.values()).filter(i=>i.team==="ct"&&i.isAlive).length,n=Array.from(this.players.values()).filter(i=>i.team==="t"&&i.isAlive).length,a=Math.max(0,Math.floor((this.roundStartTime+N-e)/1e3));let s=null;if(n===0&&t>0?s="ct":t===0&&n>0?s="t":a<=0&&(s=t>n?"ct":n>t?"t":null),s){s==="ct"?this.roundWins.ct++:this.roundWins.t++,this.roundPhase="ended",this.roundEndAt=e+zt,(r=this.onRoundEnd)==null||r.call(this,s);for(const i of this.players.values())i.credits+=i.team===s?ft:pt}}processReloads(){const e=Date.now();for(const t of this.players.values())if(t.reloadEndTime>0&&e>=t.reloadEndTime){const n=E[t.weapon];if(n){const a=n.magazineSize-t.ammo,s=Math.min(a,t.ammoReserve);t.ammo+=s,t.ammoReserve-=s,t.weaponAmmo[t.weapon]={ammo:t.ammo,reserve:t.ammoReserve}}t.reloadEndTime=0}}tick(){var a;const e=1/U,t=Date.now();this.checkRoundEnd(t);for(const s of this.players.values())if(s.id.startsWith("bot-")&&s.isAlive){const r=Array.from(this.players.values()).map(d=>({id:d.id,team:d.team,x:d.x,y:d.y,isAlive:d.isAlive})),i=Wt(s.id,s.team,s.x,s.y,s.angle,r,this.map.walls,this.tickCount);s.lastInput=i.input,s.angle=i.angle,i.shoot&&this.shoot(s.id)}this.processReloads(),kt(this.pickups,Array.from(this.players.values()),s=>{var r;return((r=E[s])==null?void 0:r.magazineSize)??30},t);for(const s of this.players.values()){if(!s.isAlive)continue;const r={x:s.x,y:s.y,vx:s.vx,vy:s.vy,angle:s.angle},i=it(r,s.lastInput,this.map,e);s.x=i.x,s.y=i.y,s.vx=i.vx,s.vy=i.vy}this.tickCount++;const n=this.roundPhase==="playing"?Math.max(0,Math.floor((this.roundStartTime+N-t)/1e3)):Math.max(0,Math.floor((this.roundEndAt-t)/1e3));(a=this.onState)==null||a.call(this,{players:Array.from(this.players.values()).map(s=>({id:s.id,x:s.x,y:s.y,angle:s.angle,team:s.team,username:s.username,health:s.health,weapon:s.weapon,ammo:s.ammo,ammoReserve:s.ammoReserve,isAlive:s.isAlive,kills:s.kills,deaths:s.deaths,credits:s.credits,weapons:s.weapons,currentSlot:s.currentSlot})),pickups:It(this.pickups,t),round:this.round,roundTimeLeft:n,roundWins:{...this.roundWins},roundPhase:this.roundPhase})}stop(){this.tickInterval&&(clearInterval(this.tickInterval),this.tickInterval=null)}}const Bt={class:"game-view"},Nt={class:"game-header"},Ut={class:"game-header-actions"},Gt=["title"],Ft={key:0,class:"scoreboard-overlay"},Kt={class:"scoreboard panel-cs"},Vt={class:"scoreboard-header"},$t={class:"scoreboard-score"},jt={class:"team-ct"},qt={class:"team-t"},Yt={class:"scoreboard-round"},Ht={class:"scoreboard-time"},Xt={class:"scoreboard-table"},Zt={class:"scoreboard-name"},Jt=j({__name:"GameView",setup(l){const e=st(),t=nt(),{fetchMap:n}=rt(),{playShot:a,playReload:s,playWinCt:r,playWinTer:i}=lt(),d=D(null);let o=null,c=null;const f=D({health:100,weapon:"usp",ammo:12,ammoReserve:24,kills:0,deaths:0,scoreCt:0,scoreT:0,credits:800,weapons:[null,"usp"],currentSlot:1,round:1,roundTimeLeft:180}),h=D(!1),u=D(!1),m=D([]),y=et(()=>[...m.value].sort((g,M)=>g.team!==M.team?g.team==="ct"?-1:1:M.kills-g.kills)),A=D(null),{isFullscreen:v,toggle:T}=ct(A);function x(k){k.code==="Tab"?(k.preventDefault(),u.value=!u.value):k.code==="Escape"&&(u.value=!1)}async function R(){const k=e.params.mapId||"dust2",g=d.value;if(g)try{const M=await n(k);c=new Lt(M),o=new mt({canvas:g,map:M,localPlayerId:"local",networked:!0,onInput:w=>{c==null||c.setInput("local",{up:w.up??!1,down:w.down??!1,left:w.left??!1,right:w.right??!1}),c==null||c.setAngle("local",w.angle)},onShoot:()=>c==null?void 0:c.shoot("local"),onReload:()=>{c==null||c.reload("local"),s()},onSwitchWeapon:w=>c==null?void 0:c.switchWeapon("local",w),onOpenShop:()=>{h.value=!h.value},onHUDUpdate:w=>{f.value=w}}),c.setOnState(w=>{m.value=w.players,o==null||o.setServerState(w.players,w.pickups,{round:w.round,roundTimeLeft:w.roundTimeLeft,roundWins:w.roundWins})}),c.setOnShotTrail((w,G,F,K)=>{o==null||o.addBulletTrail(w,G,F,K)}),c.setOnShot(w=>a(w)),c.setOnRoundEnd(w=>{w==="ct"?r():i()}),c.start(),o.setFogOfWar(!0),o.start()}catch(M){console.error("Failed to load map:",M)}}function _(k){c==null||c.buyWeapon("local",k),h.value=!1}function P(){t.push({name:"home"})}return q(()=>{R(),window.addEventListener("keydown",x)}),Y(()=>{window.removeEventListener("keydown",x),c==null||c.stop(),c=null,o==null||o.stop(),o=null}),H(()=>e.params.mapId,()=>{c==null||c.stop(),c=null,o==null||o.stop(),R()}),(k,g)=>(O(),W("div",Bt,[p("div",Nt,[g[2]||(g[2]=p("h2",null,"Игра (одиночный режим)",-1)),g[3]||(g[3]=p("p",{class:"hint"},"WASD — движение, мышь — прицел, ЛКМ — стрельба, R — перезарядка, 1/2 — оружие, B — магазин",-1)),p("div",Ut,[p("button",{type:"button",class:"btn-exit",onClick:P},"Выйти"),p("button",{type:"button",class:"btn-fullscreen",title:b(v)?"Выйти из полноэкранного режима":"На весь экран",onClick:g[0]||(g[0]=(...M)=>b(T)&&b(T)(...M))},I(b(v)?"⊡":"⊞"),9,Gt)])]),p("div",{ref_key:"canvasWrapRef",ref:A,class:"game-canvas-wrap"},[p("canvas",{ref_key:"canvasRef",ref:d,class:"game-canvas"},null,512),u.value?(O(),W("div",Ft,[p("div",Kt,[p("div",Vt,[p("span",$t,[p("span",jt,I(f.value.scoreCt),1),g[4]||(g[4]=p("span",{class:"scoreboard-sep"},":",-1)),p("span",qt,I(f.value.scoreT),1)]),p("span",Yt,"Раунд "+I(f.value.round),1),p("span",Ht,I(Math.floor((f.value.roundTimeLeft??0)/60))+":"+I(String((f.value.roundTimeLeft??0)%60).padStart(2,"0")),1)]),p("div",Xt,[g[5]||(g[5]=p("div",{class:"scoreboard-row scoreboard-head"},[p("span",null,"Игрок"),p("span",null,"K"),p("span",null,"D")],-1)),(O(!0),W(X,null,Z(y.value,M=>(O(),W("div",{key:M.id,class:at(["scoreboard-row",M.team])},[p("span",Zt,I(M.username),1),p("span",null,I(M.kills),1),p("span",null,I(M.deaths),1)],2))),128))]),g[6]||(g[6]=p("p",{class:"scoreboard-hint"},"TAB или ESC — закрыть",-1))])])):J("",!0),z(dt,Q(tt(f.value)),null,16),z(ut,{show:h.value,credits:f.value.credits,weapons:f.value.weapons,onClose:g[1]||(g[1]=M=>h.value=!1),onBuy:_},null,8,["show","credits","weapons"])],512)]))}}),ne=ot(Jt,[["__scopeId","data-v-4c0016fc"]]);export{ne as default};
