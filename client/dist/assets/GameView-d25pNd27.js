var Q=Object.defineProperty;var tt=(c,e,t)=>e in c?Q(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t;var M=(c,e,t)=>tt(c,typeof e!="symbol"?e+"":e,t);import{d as et,s as st,x as ot,q as nt,c as C,a as p,j as B,m as L,b as W,t as _,F as at,l as it,e as rt,f as N,A as lt,B as ct,p as P,z as ut,C as dt,g as mt,o as O,n as ht,_ as pt}from"./index-AYzDde7z.js";import{u as ft}from"./MapRenderer-CCBU4K5V.js";import{u as yt,a as vt,b as wt,G as gt,S as At,c as Mt}from"./ShopModal-CCLjhdzs.js";const St=300,xt=3250,Tt=1400,U=800,k={usp:{id:"usp",name:"USP-S",damage:35,magazineSize:12,fireRateMs:150,reloadTimeMs:2200,range:600,spread:.02},ak47:{id:"ak47",name:"AK-47",damage:36,magazineSize:30,fireRateMs:100,reloadTimeMs:2500,range:690,spread:.04,price:2700},m4:{id:"m4",name:"M4A1",damage:33,magazineSize:30,fireRateMs:90,reloadTimeMs:3100,range:690,spread:.03,price:3100}},Rt={ct:"usp"};function kt(c,e,t,s,a,l,o,r){const u=(c-t)*(l-r)-(e-s)*(a-o);if(Math.abs(u)<1e-10)return null;const i=((c-a)*(l-r)-(e-l)*(a-o))/u,y=-((c-t)*(e-l)-(e-s)*(c-a))/u;return i>=0&&i<=1&&y>=0&&y<=1?{x:c+i*(t-c),y:e+i*(s-e),t:i}:null}function It(c,e,t,s,a,l){const o=a-t,r=l-s,u=o*o+r*r;if(u===0)return{dist:Math.hypot(c-t,e-s),t:0};let i=((c-t)*o+(e-s)*r)/u;i=Math.max(0,Math.min(1,i));const y=t+i*o,g=s+i*r;return{dist:Math.hypot(c-y,e-g),t:i}}function _t(c,e,t,s,a,l){const o=c+t*a,r=e+s*a;let u=1;for(const i of l){const y=[[i.x,i.y,i.x+i.width,i.y],[i.x+i.width,i.y,i.x+i.width,i.y+i.height],[i.x+i.width,i.y+i.height,i.x,i.y+i.height],[i.x,i.y+i.height,i.x,i.y]];for(const[g,m,n,d]of y){const h=kt(c,e,o,r,g,m,n,d);h&&h.t<u&&(u=h.t)}}return u*a}function bt(c,e,t,s,a,l,o,r){const u=(Math.random()-.5)*a*Math.PI,i=Math.cos(t+u),y=Math.sin(t+u),g=_t(c,e,i,y,s,l);let m=null;const n=c+i*s,d=e+y*s;for(const h of o){if(h.id===r)continue;const{dist:S,t:R}=It(h.x,h.y,c,e,n,d);if(S>h.radius)continue;const x=R*s-Math.sqrt(Math.max(0,h.radius*h.radius-S*S));x<0||x>g||(!m||x<m.dist)&&(m={hitId:h.id,dist:x})}return m}const F=25,Et=3e4,Pt=45e3,Dt=1,G=15e3;function Ct(c,e,t,s=40){for(const a of t){const l=a.x-s,o=a.y-s,r=a.width+s*2,u=a.height+s*2;if(c>=l&&c<=l+r&&e>=o&&e<=o+u)return!0}return!1}function j(c,e,t){for(let s=0;s<50;s++){const a=80+Math.random()*(c-160),l=80+Math.random()*(e-160);if(!Ct(a,l,t))return{x:a,y:l}}return{x:c/2,y:e/2}}function Wt(c,e){const t=[],s=new Set,a=l=>{const o=j(c.width,c.height,c.walls),r=`${Math.floor(o.x/50)}_${Math.floor(o.y/50)}`;s.has(r)||(s.add(r),t.push({id:`pickup_${t.length}`,type:l,x:o.x,y:o.y,respawnAt:0}))};for(let l=0;l<e.ammo;l++)a("ammo");for(let l=0;l<e.medkit;l++)a("medkit");return t}function Ot(c,e,t){for(const s of c){if(s.respawnAt>t)continue;const a=j(e.width,e.height,e.walls);s.x=a.x,s.y=a.y}}function zt(c,e,t,s,a){var l;for(const o of c)if(!(o.respawnAt>s))for(const r of e){if(!r.isAlive)continue;const u=r.x-o.x,i=r.y-o.y;if(!(u*u+i*i>F*F)){if(o.type==="ammo"){const y=t(r.weapon)??30;r.ammoReserve+=y*Dt,(l=r.weaponAmmo)!=null&&l[r.weapon]&&(r.weaponAmmo[r.weapon].reserve=r.ammoReserve)}else o.type==="medkit"&&(r.health=Math.min(100,r.health+20));o.respawnAt=s+(o.type==="ammo"?Et:Pt),a==null||a(o.type);break}}}function Bt(c,e){return c.filter(t=>t.respawnAt<=e).map(t=>({id:t.id,type:t.type,x:t.x,y:t.y}))}const K=["Bot Ivan","Bot Dmitry","Bot Alex","Bot Sergei"];function V(c){return K[c%K.length]}function Lt(c,e,t,s,a,l=2e3){const o=t-c,r=s-e,u=Math.hypot(o,r);if(u>l)return!1;const i=u>0?o/u:0,y=u>0?r/u:0,g=c+i*u,m=e+y*u;for(const n of a){const d=[[n.x,n.y,n.x+n.width,n.y],[n.x+n.width,n.y,n.x+n.width,n.y+n.height],[n.x+n.width,n.y+n.height,n.x,n.y+n.height],[n.x,n.y+n.height,n.x,n.y]];for(const[h,S,R,A]of d){const x=(c-g)*(S-A)-(e-m)*(h-R);if(Math.abs(x)<1e-10)continue;const D=((h-c)*(S-A)-(S-e)*(h-R))/x,T=-((c-g)*(S-e)-(e-m)*(h-c))/x;if(D>=0&&D<=1&&T>=0&&T<=1)return!1}}return!0}function Ut(c,e){let t=e-c;for(;t>Math.PI;)t-=2*Math.PI;for(;t<-Math.PI;)t+=2*Math.PI;return t}function Nt(c,e,t,s,a,l,o,r,u="medium"){const i=l.filter(A=>A.team!==e&&A.isAlive),y=u==="easy"?.3:u==="medium"?.6:.9,g=u==="easy"?.4:u==="medium"?.15:.05,m=u==="easy"?.3:u==="medium"?.5:.85;let n=null,d=1/0;for(const A of i){const x=Math.hypot(A.x-t,A.y-s);x<d&&Lt(t,s,A.x,A.y,o)&&(d=x,n=A)}const h={up:!1,down:!1,left:!1,right:!1};let S=a,R=!1;if(n&&Math.random()<y){const A=Math.atan2(n.y-s,n.x-t),x=(Math.random()-.5)*2*g*Math.PI;if(S=A+x,Math.abs(Ut(a,S))<.15&&(R=!0),d>250&&Math.random()<m){const T=A,E=Math.cos(T),b=Math.sin(T);E>.3?h.right=!0:E<-.3&&(h.left=!0),b>.3?h.down=!0:b<-.3&&(h.up=!0)}else if(d<150&&Math.random()<.5){const T=Math.atan2(s-n.y,t-n.x),E=Math.cos(T),b=Math.sin(T);E>.3?h.right=!0:E<-.3&&(h.left=!0),b>.3?h.down=!0:b<-.3&&(h.up=!0)}}else if(r%60<30&&Math.random()<.1){const A=Math.floor(Math.random()*4);A===0?h.up=!0:A===1?h.down=!0:A===2?h.left=!0:h.right=!0}return{input:h,angle:S,shoot:R}}const q=20,Ft=1e3/q,Gt=23,$=180*1e3,Kt=5e3,Vt=2,$t=8;class jt{constructor(e,t){M(this,"map");M(this,"options");M(this,"players",new Map);M(this,"pickups",[]);M(this,"tickInterval",null);M(this,"tickCount",0);M(this,"round",1);M(this,"roundStartTime",0);M(this,"roundWins",{ct:0,t:0});M(this,"roundPhase","playing");M(this,"roundEndAt",0);M(this,"lastPickupRelocateInterval",-1);M(this,"onState");M(this,"onShotTrail");M(this,"onShot");M(this,"onRoundEnd");M(this,"onPickup");this.map=e,this.options=t??{}}start(){const e={ct:[...this.map.spawnPoints.ct],t:[...this.map.spawnPoints.t]};let t=0,s=0;const a=Rt.ct,l=k[a],o=e.ct[0]||{x:100,y:100};this.players.set("local",{id:"local",team:"ct",username:"You",x:o.x+30,y:o.y+30,angle:0,vx:0,vy:0,health:100,weapon:a,ammo:l.magazineSize,ammoReserve:24,isAlive:!0,kills:0,deaths:0,credits:U,weapons:[null,a],currentSlot:1,weaponAmmo:{},lastInput:{up:!1,down:!1,left:!1,right:!1},lastShotTime:0,reloadEndTime:0});const r=this.options.ctBotCount??Vt,u=this.options.tBotCount??$t;let i=0;for(let y=0;y<r;y++){const g=e.ct,m=t++,n=g[m%g.length]||{x:100,y:100},d=`bot-${i++}`,h=k[a];this.players.set(d,{id:d,team:"ct",username:V(i-1),x:n.x+30,y:n.y+30,angle:0,vx:0,vy:0,health:100,weapon:a,ammo:h.magazineSize,ammoReserve:24,isAlive:!0,kills:0,deaths:0,credits:U,weapons:[null,a],currentSlot:1,weaponAmmo:{},lastInput:{up:!1,down:!1,left:!1,right:!1},lastShotTime:0,reloadEndTime:0})}for(let y=0;y<u;y++){const g=e.t,m=s++,n=g[m%g.length]||{x:100,y:100},d=`bot-${i++}`,h=k[a];this.players.set(d,{id:d,team:"t",username:V(i-1),x:n.x+30,y:n.y+30,angle:0,vx:0,vy:0,health:100,weapon:a,ammo:h.magazineSize,ammoReserve:24,isAlive:!0,kills:0,deaths:0,credits:U,weapons:[null,a],currentSlot:1,weaponAmmo:{},lastInput:{up:!1,down:!1,left:!1,right:!1},lastShotTime:0,reloadEndTime:0})}this.pickups=Wt(this.map,{ammo:5,medkit:3}),this.roundStartTime=Date.now(),this.lastPickupRelocateInterval=Math.floor(Date.now()/G),this.tickInterval=setInterval(()=>this.tick(),Ft)}setOnState(e){this.onState=e}setOnShotTrail(e){this.onShotTrail=e}setOnShot(e){this.onShot=e}setOnRoundEnd(e){this.onRoundEnd=e}setOnPickup(e){this.onPickup=e}setInput(e,t){const s=this.players.get(e);s&&(s.lastInput=t)}setAngle(e,t){const s=this.players.get(e);s&&(s.angle=t)}shoot(e){var m,n;const t=this.players.get(e);if(!t||!t.isAlive)return;const s=Date.now(),a=k[t.weapon];if(!a||t.reloadEndTime>s)return;if(t.ammo<=0){this.startReload(t);return}if(s-t.lastShotTime<a.fireRateMs)return;t.lastShotTime=s,t.ammo--,t.weaponAmmo[t.weapon]={ammo:t.ammo,reserve:t.ammoReserve};const l=(Math.random()-.5)*a.spread*Math.PI,o=t.angle+l,r=Array.from(this.players.values()).filter(d=>d.isAlive).map(d=>({id:d.id,team:d.team,x:d.x,y:d.y,radius:Gt})),u=bt(t.x,t.y,o,a.range,0,this.map.walls,r,e),i=u?u.dist:a.range,y=t.x+Math.cos(o)*i,g=t.y+Math.sin(o)*i;if((m=this.onShotTrail)==null||m.call(this,t.x,t.y,y,g),(n=this.onShot)==null||n.call(this,t.weapon),u){const d=this.players.get(u.hitId);d&&d.team!==t.team&&(d.health=Math.max(0,d.health-a.damage),d.health<=0&&(d.isAlive=!1,d.deaths++,t.kills++,t.credits+=St))}}reload(e){const t=this.players.get(e);if(!t||!t.isAlive||t.ammoReserve<=0)return;const s=k[t.weapon];!s||t.ammo>=s.magazineSize||Date.now()<t.reloadEndTime||this.startReload(t)}startReload(e){const t=k[e.weapon];!t||t.reloadTimeMs<=0||(e.reloadEndTime=Date.now()+t.reloadTimeMs)}switchWeapon(e,t){const s=this.players.get(e);!s||!s.isAlive||!s.weapons[t]&&t===0||t!==s.currentSlot&&(s.weaponAmmo[s.weapon]={ammo:s.ammo,reserve:s.ammoReserve},s.currentSlot=t,this.applyWeaponSlot(s))}buyWeapon(e,t){const s=this.players.get(e);if(!s||!s.isAlive)return;const a=k[t];if(!(!a||!a.price)&&!(s.credits<a.price)&&(t==="ak47"||t==="m4")){if(s.weapons[0])return;s.credits-=a.price,s.weapons[0]=t,s.weaponAmmo[t]={ammo:a.magazineSize,reserve:0},s.weaponAmmo[s.weapon]={ammo:s.ammo,reserve:s.ammoReserve},s.currentSlot=0,this.applyWeaponSlot(s)}}applyWeaponSlot(e){const t=e.weapons[e.currentSlot];e.weapon=t??e.weapons[1];const s=k[e.weapon];if(!s)return;const a=e.weaponAmmo[e.weapon];a?(e.ammo=a.ammo,e.ammoReserve=a.reserve):(e.ammo=s.magazineSize,e.ammoReserve=e.weapon==="usp"?24:90)}respawnAll(){const e={ct:[...this.map.spawnPoints.ct],t:[...this.map.spawnPoints.t]};let t=0,s=0;for(const a of this.players.values()){const l=a.team==="ct"?e.ct:e.t,o=a.team==="ct"?t++:s++,r=l[o%l.length]||{x:100,y:100};a.x=r.x+30,a.y=r.y+30,a.vx=0,a.vy=0,a.health=100,a.isAlive=!0,a.reloadEndTime=0,this.applyWeaponSlot(a)}}checkRoundEnd(e){var o;if(this.roundPhase==="ended"){e>=this.roundEndAt&&(this.round++,this.roundPhase="playing",this.roundStartTime=e,this.respawnAll());return}const t=Array.from(this.players.values()).filter(r=>r.team==="ct"&&r.isAlive).length,s=Array.from(this.players.values()).filter(r=>r.team==="t"&&r.isAlive).length,a=Math.max(0,Math.floor((this.roundStartTime+$-e)/1e3));let l=null;if(s===0&&t>0?l="ct":t===0&&s>0?l="t":a<=0&&(l=t>s?"ct":s>t?"t":null),l){l==="ct"?this.roundWins.ct++:this.roundWins.t++,this.roundPhase="ended",this.roundEndAt=e+Kt,(o=this.onRoundEnd)==null||o.call(this,l);for(const r of this.players.values())r.credits+=r.team===l?xt:Tt}}processReloads(){const e=Date.now();for(const t of this.players.values())if(t.reloadEndTime>0&&e>=t.reloadEndTime){const s=k[t.weapon];if(s){const a=s.magazineSize-t.ammo,l=Math.min(a,t.ammoReserve);t.ammo+=l,t.ammoReserve-=l,t.weaponAmmo[t.weapon]={ammo:t.ammo,reserve:t.ammoReserve}}t.reloadEndTime=0}}tick(){var l;const e=1/q,t=Date.now();this.checkRoundEnd(t);for(const o of this.players.values())if(o.id.startsWith("bot-")&&o.isAlive){const r=Array.from(this.players.values()).map(y=>({id:y.id,team:y.team,x:y.x,y:y.y,isAlive:y.isAlive})),u=this.options.botDifficulty??"medium",i=Nt(o.id,o.team,o.x,o.y,o.angle,r,this.map.walls,this.tickCount,u);o.lastInput=i.input,o.angle=i.angle,i.shoot&&this.shoot(o.id)}this.processReloads(),zt(this.pickups,Array.from(this.players.values()),o=>{var r;return((r=k[o])==null?void 0:r.magazineSize)??30},t,this.onPickup);const s=Math.floor(t/G);s!==this.lastPickupRelocateInterval&&(this.lastPickupRelocateInterval=s,Ot(this.pickups,this.map,t));for(const o of this.players.values()){if(!o.isAlive)continue;const r={x:o.x,y:o.y,vx:o.vx,vy:o.vy,angle:o.angle},u=yt(r,o.lastInput,this.map,e);o.x=u.x,o.y=u.y,o.vx=u.vx,o.vy=u.vy}this.tickCount++;const a=this.roundPhase==="playing"?Math.max(0,Math.floor((this.roundStartTime+$-t)/1e3)):Math.max(0,Math.floor((this.roundEndAt-t)/1e3));(l=this.onState)==null||l.call(this,{players:Array.from(this.players.values()).map(o=>({id:o.id,x:o.x,y:o.y,angle:o.angle,team:o.team,username:o.username,health:o.health,weapon:o.weapon,ammo:o.ammo,ammoReserve:o.ammoReserve,isAlive:o.isAlive,kills:o.kills,deaths:o.deaths,credits:o.credits,weapons:o.weapons,currentSlot:o.currentSlot})),pickups:Bt(this.pickups,t),round:this.round,roundTimeLeft:a,roundWins:{...this.roundWins},roundPhase:this.roundPhase})}stop(){this.tickInterval&&(clearInterval(this.tickInterval),this.tickInterval=null)}}const qt={class:"game-view"},Yt={class:"game-header"},Ht={class:"bot-difficulty-row"},Xt={class:"bot-difficulty-opt"},Zt={class:"bot-difficulty-opt"},Jt={class:"bot-difficulty-opt"},Qt={class:"game-header-actions"},te=["title"],ee={key:0,class:"scoreboard-overlay"},se={class:"scoreboard panel-cs"},oe={class:"scoreboard-header"},ne={class:"scoreboard-score"},ae={class:"team-ct"},ie={class:"team-t"},re={class:"scoreboard-round"},le={class:"scoreboard-time"},ce={class:"scoreboard-table"},ue={class:"scoreboard-name"},de=et({__name:"GameView",setup(c){const e=dt(),t=mt(),s=P("medium"),{fetchMap:a}=ft(),{playShot:l,playReload:o,playWinCt:r,playWinTer:u,playPickupAmmo:i,playPickupMedkit:y}=vt(),g=P(null);let m=null,n=null;const d=P({health:100,weapon:"usp",ammo:12,ammoReserve:24,kills:0,deaths:0,scoreCt:0,scoreT:0,credits:800,weapons:[null,"usp"],currentSlot:1,round:1,roundTimeLeft:180}),h=P(!1),S=P(!1),R=P([]),A=ut(()=>[...R.value].sort((f,w)=>f.team!==w.team?f.team==="ct"?-1:1:w.kills-f.kills)),x=P(null),{isFullscreen:D,toggle:T}=wt(x);function E(){m==null||m.stop(),n==null||n.stop(),m=null,n=null,z()}function b(I){I.code==="Tab"?(I.preventDefault(),S.value=!S.value):I.code==="Escape"&&(S.value=!1)}async function z(){const I=e.params.mapId||"dust2",f=g.value;if(f)try{const w=await a(I);n=new jt(w,{ctBotCount:2,tBotCount:8,botDifficulty:s.value}),m=new Mt({canvas:f,map:w,localPlayerId:"local",networked:!0,onInput:v=>{n==null||n.setInput("local",{up:v.up??!1,down:v.down??!1,left:v.left??!1,right:v.right??!1}),n==null||n.setAngle("local",v.angle)},onShoot:()=>n==null?void 0:n.shoot("local"),onReload:()=>{n==null||n.reload("local"),o()},onSwitchWeapon:v=>n==null?void 0:n.switchWeapon("local",v),onOpenShop:()=>{h.value=!h.value},onHUDUpdate:v=>{d.value=v}}),n.setOnState(v=>{R.value=v.players,m==null||m.setServerState(v.players,v.pickups,{round:v.round,roundTimeLeft:v.roundTimeLeft,roundWins:v.roundWins})}),n.setOnShotTrail((v,X,Z,J)=>{m==null||m.addBulletTrail(v,X,Z,J)}),n.setOnShot(v=>l(v)),n.setOnRoundEnd(v=>{v==="ct"?r():u()}),n.setOnPickup(v=>{v==="ammo"?i():y()}),n.start(),m.setFogOfWar(!0),m.start()}catch(w){console.error("Failed to load map:",w)}}function Y(I){n==null||n.buyWeapon("local",I),h.value=!1}function H(){t.push({name:"home"})}return st(()=>{z(),window.addEventListener("keydown",b)}),ot(()=>{window.removeEventListener("keydown",b),n==null||n.stop(),n=null,m==null||m.stop(),m=null}),nt(()=>e.params.mapId,()=>{n==null||n.stop(),n=null,m==null||m.stop(),z()}),(I,f)=>(O(),C("div",qt,[p("div",Yt,[f[9]||(f[9]=p("h2",null,"Тренировка",-1)),p("div",Ht,[f[8]||(f[8]=p("span",{class:"bot-difficulty-label"},"Уровень ботов:",-1)),p("label",Xt,[B(p("input",{"onUpdate:modelValue":f[0]||(f[0]=w=>s.value=w),type:"radio",value:"easy"},null,512),[[L,s.value]]),f[5]||(f[5]=p("span",null,"Лёгкий",-1))]),p("label",Zt,[B(p("input",{"onUpdate:modelValue":f[1]||(f[1]=w=>s.value=w),type:"radio",value:"medium"},null,512),[[L,s.value]]),f[6]||(f[6]=p("span",null,"Средний",-1))]),p("label",Jt,[B(p("input",{"onUpdate:modelValue":f[2]||(f[2]=w=>s.value=w),type:"radio",value:"hard"},null,512),[[L,s.value]]),f[7]||(f[7]=p("span",null,"Сложный",-1))]),p("button",{type:"button",class:"btn-cs btn-apply",onClick:E},"Применить")]),f[10]||(f[10]=p("p",{class:"hint"},"WASD — движение, мышь — прицел, ЛКМ — стрельба, R — перезарядка, 1/2 — оружие, B — магазин",-1)),p("div",Qt,[p("button",{type:"button",class:"btn-exit",onClick:H},"Выйти"),p("button",{type:"button",class:"btn-fullscreen",title:W(D)?"Выйти из полноэкранного режима":"На весь экран",onClick:f[3]||(f[3]=(...w)=>W(T)&&W(T)(...w))},_(W(D)?"⊡":"⊞"),9,te)])]),p("div",{ref_key:"canvasWrapRef",ref:x,class:"game-canvas-wrap"},[p("canvas",{ref_key:"canvasRef",ref:g,class:"game-canvas"},null,512),S.value?(O(),C("div",ee,[p("div",se,[p("div",oe,[p("span",ne,[p("span",ae,_(d.value.scoreCt),1),f[11]||(f[11]=p("span",{class:"scoreboard-sep"},":",-1)),p("span",ie,_(d.value.scoreT),1)]),p("span",re,"Раунд "+_(d.value.round),1),p("span",le,_(Math.floor((d.value.roundTimeLeft??0)/60))+":"+_(String((d.value.roundTimeLeft??0)%60).padStart(2,"0")),1)]),p("div",ce,[f[12]||(f[12]=p("div",{class:"scoreboard-row scoreboard-head"},[p("span",null,"Игрок"),p("span",null,"K"),p("span",null,"D")],-1)),(O(!0),C(at,null,it(A.value,w=>(O(),C("div",{key:w.id,class:ht(["scoreboard-row",w.team])},[p("span",ue,_(w.username),1),p("span",null,_(w.kills),1),p("span",null,_(w.deaths),1)],2))),128))]),f[13]||(f[13]=p("p",{class:"scoreboard-hint"},"TAB или ESC — закрыть",-1))])])):rt("",!0),N(gt,lt(ct(d.value)),null,16),N(At,{show:h.value,credits:d.value.credits,weapons:d.value.weapons,onClose:f[4]||(f[4]=w=>h.value=!1),onBuy:Y},null,8,["show","credits","weapons"])],512)]))}}),ye=pt(de,[["__scopeId","data-v-c232e0b4"]]);export{ye as default};
