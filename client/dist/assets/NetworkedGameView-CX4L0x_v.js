import{a as le,b as te,G as ae,S as ne,c as re}from"./ShopModal-DUf5KCSU.js";import{d as ue,s as ie,x as q,q as ce,c as u,a as s,b as k,t as a,F as I,l as C,e as L,f as H,A as de,B as pe,p as i,z as F,C as me,g as ve,o as c,n as $,_ as fe}from"./index-Dje41XHH.js";import{u as ye}from"./MapRenderer-xkhg8OLD.js";import{a as ke,u as we}from"./room-CZclbwgM.js";const be={class:"game-view"},_e={class:"game-header"},he={class:"game-header-actions"},ge=["title"],Se={key:0,class:"kill-feed"},Te={class:"kill-feed-killer"},Re={class:"kill-feed-victim"},Ie={key:1,class:"scoreboard-overlay"},Ce={class:"scoreboard panel-cs"},Le={class:"scoreboard-header"},Fe={class:"scoreboard-score"},Ne={class:"team-ct"},We={class:"team-t"},De={class:"scoreboard-round"},Ee={class:"scoreboard-time"},Ge={class:"scoreboard-table"},Be={class:"scoreboard-name"},Oe={key:2,class:"game-over-overlay"},xe={class:"game-over-card panel-cs"},Me={class:"game-over-title"},Pe={class:"stats-table"},Ue=5e3,Ve=ue({__name:"NetworkedGameView",setup(Ae){const _=me(),h=ve(),{fetchMap:j}=ye(),{connect:J,socket:r}=ke(),g=we(),{playShot:Q,playReload:X,playWinCt:Y,playWinTer:Z}=le(),N=i(null);let t=null;const d=i({health:100,weapon:"usp",ammo:12,ammoReserve:24,kills:0,deaths:0,scoreCt:0,scoreT:0,credits:800,weapons:[null,"usp"],currentSlot:1,round:1,roundTimeLeft:180}),f=i(!1),W=i(null),{isFullscreen:D,toggle:E}=te(W),G=i(null),S=i("dust2"),v=i(null),w=i([]),B=F(()=>[...w.value].slice(-6).reverse()),b=i(!1),T=i([]),ee=F(()=>[...T.value].sort((o,l)=>o.team!==l.team?o.team==="ct"?-1:1:l.kills-o.kills)),se=F(()=>v.value?[...v.value.players].sort((n,o)=>n.team!==o.team?n.team==="ct"?-1:1:o.kills-n.kills):[]);function O(){g.leaveRoom(),v.value=null,h.push({name:"lobby"})}async function x(){var l,m,P,U;G.value=_.params.roomId||null;const n=N.value;if(!n||!G.value){h.push({name:"lobby"});return}J(),g.setupListeners();const o=g.currentRoom;if(o)S.value=o.map;else{const y=_.query.mapId;S.value=y||"dust2"}try{const y=await j(S.value),oe=((l=r.value)==null?void 0:l.id)??"local";t=new re({canvas:n,map:y,localPlayerId:oe,networked:!0,onInput:e=>{var p;(p=r.value)==null||p.emit("player:move",{up:e.up??!1,down:e.down??!1,left:e.left??!1,right:e.right??!1,angle:e.angle})},onShoot:()=>{var e;return(e=r.value)==null?void 0:e.emit("player:shoot")},onReload:()=>{var e;return(e=r.value)==null?void 0:e.emit("player:reload")},onSwitchWeapon:e=>{var p;return(p=r.value)==null?void 0:p.emit("player:switchWeapon",e)},onOpenShop:()=>{f.value=!f.value},onHUDUpdate:e=>{d.value=e}});const V=e=>{T.value=e.players,t==null||t.setServerState(e.players,e.pickups,e.round!=null?{round:e.round,roundTimeLeft:e.roundTimeLeft??180,roundWins:e.roundWins}:void 0)},A=e=>{T.value=e.players,t==null||t.setServerState(e.players,e.pickups,e.round!=null?{round:e.round,roundTimeLeft:e.roundTimeLeft??180,roundWins:e.roundWins}:void 0)},K=e=>{e.type==="shot"?(e.weapon&&Q(e.weapon),e.trail&&t&&t.addBulletTrail(e.trail.x1,e.trail.y1,e.trail.x2,e.trail.y2)):e.type==="reloadStart"?X():e.type==="kill"?w.value.push({killerName:e.killerName??"?",victimName:e.victimName??"?",time:Date.now()}):e.type==="roundEnd"?e.winner==="ct"?Y():e.winner==="t"&&Z():e.type==="gameOver"&&e.winner&&e.players&&(v.value={winner:e.winner,players:e.players})};(m=r.value)==null||m.on("game:state",V),(P=r.value)==null||P.on("game:update",A),(U=r.value)==null||U.on("game:event",K),t.setFogOfWar(!0),t.start(),q(()=>{var e,p,z;(e=r.value)==null||e.off("game:state",V),(p=r.value)==null||p.off("game:update",A),(z=r.value)==null||z.off("game:event",K)})}catch(y){console.error("Failed to init networked game:",y),h.push({name:"lobby"})}}let R=null;function M(n){n.code==="Tab"?(n.preventDefault(),b.value=!b.value):n.code==="Escape"&&(b.value=!1)}return ie(()=>{x(),R=setInterval(()=>{const n=Date.now();w.value=w.value.filter(o=>n-o.time<Ue)},500),window.addEventListener("keydown",M)}),q(()=>{window.removeEventListener("keydown",M),R&&clearInterval(R),t==null||t.stop(),t=null}),ce(()=>_.params.roomId,()=>{t==null||t.stop(),x()}),(n,o)=>(c(),u("div",be,[s("div",_e,[o[3]||(o[3]=s("h2",null,"Сетевая игра",-1)),o[4]||(o[4]=s("p",{class:"hint"},"WASD — движение, мышь — прицел, ЛКМ — стрельба, R — перезарядка, 1/2 — оружие, B — магазин",-1)),s("div",he,[s("button",{type:"button",class:"btn-cs",onClick:O},"Выйти"),s("button",{type:"button",class:"btn-fullscreen",title:k(D)?"Выйти из полноэкранного режима":"На весь экран",onClick:o[0]||(o[0]=(...l)=>k(E)&&k(E)(...l))},a(k(D)?"⊡":"⊞"),9,ge)])]),s("div",{ref_key:"canvasWrapRef",ref:W,class:"game-canvas-wrap"},[s("canvas",{ref_key:"canvasRef",ref:N,class:"game-canvas"},null,512),B.value.length?(c(),u("div",Se,[(c(!0),u(I,null,C(B.value,(l,m)=>(c(),u("div",{key:m,class:"kill-feed-entry"},[s("span",Te,a(l.killerName),1),o[5]||(o[5]=s("span",{class:"kill-feed-sep"}," → ",-1)),s("span",Re,a(l.victimName),1)]))),128))])):L("",!0),b.value?(c(),u("div",Ie,[s("div",Ce,[s("div",Le,[s("span",Fe,[s("span",Ne,a(d.value.scoreCt),1),o[6]||(o[6]=s("span",{class:"scoreboard-sep"},":",-1)),s("span",We,a(d.value.scoreT),1)]),s("span",De,"Раунд "+a(d.value.round),1),s("span",Ee,a(Math.floor((d.value.roundTimeLeft??0)/60))+":"+a(String((d.value.roundTimeLeft??0)%60).padStart(2,"0")),1)]),s("div",Ge,[o[7]||(o[7]=s("div",{class:"scoreboard-row scoreboard-head"},[s("span",null,"Игрок"),s("span",null,"K"),s("span",null,"D")],-1)),(c(!0),u(I,null,C(ee.value,l=>(c(),u("div",{key:l.id,class:$(["scoreboard-row",l.team])},[s("span",Be,a(l.username),1),s("span",null,a(l.kills),1),s("span",null,a(l.deaths),1)],2))),128))]),o[8]||(o[8]=s("p",{class:"scoreboard-hint"},"TAB или ESC — закрыть",-1))])])):L("",!0),H(ae,de(pe(d.value)),null,16),H(ne,{show:f.value,credits:d.value.credits,weapons:d.value.weapons,onClose:o[1]||(o[1]=l=>f.value=!1),onBuy:o[2]||(o[2]=l=>{var m;(m=k(r))==null||m.emit("player:buy",l),f.value=!1})},null,8,["show","credits","weapons"]),v.value?(c(),u("div",Oe,[s("div",xe,[s("h2",Me,a(v.value.winner==="ct"?"CT":"T")+" ПОБЕДИЛИ!",1),s("div",Pe,[o[9]||(o[9]=s("div",{class:"stats-header"},[s("span",null,"Игрок"),s("span",null,"Команда"),s("span",null,"K"),s("span",null,"D")],-1)),(c(!0),u(I,null,C(se.value,l=>(c(),u("div",{key:l.id,class:$(["stats-row",l.team])},[s("span",null,a(l.username),1),s("span",null,a(l.team==="ct"?"CT":"T"),1),s("span",null,a(l.kills),1),s("span",null,a(l.deaths),1)],2))),128))]),s("button",{type:"button",class:"btn-cs btn-cs-primary",onClick:O}," Выход ")])])):L("",!0)],512)]))}}),$e=fe(Ve,[["__scopeId","data-v-eeef58f6"]]);export{$e as default};
