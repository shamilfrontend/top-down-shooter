import{a as ne,b as ae,G as re,S as ue,c as ie}from"./ShopModal-CCLjhdzs.js";import{d as ce,s as de,x as H,q as pe,c as u,a as s,b as k,t as n,F as C,l as L,e as F,f as $,A as me,B as ve,p as i,z as N,C as fe,g as ye,o as c,n as j,_ as ke}from"./index-AYzDde7z.js";import{u as we}from"./MapRenderer-CCBU4K5V.js";import{a as be,u as _e}from"./room-BtTLukKK.js";const he={class:"game-view"},ge={class:"game-header"},Se={class:"game-header-actions"},Te=["title"],Ie={key:0,class:"kill-feed"},Re={class:"kill-feed-killer"},Ce={class:"kill-feed-victim"},Le={key:1,class:"scoreboard-overlay"},Fe={class:"scoreboard panel-cs"},Ne={class:"scoreboard-header"},We={class:"scoreboard-score"},De={class:"team-ct"},Ee={class:"team-t"},Ge={class:"scoreboard-round"},Be={class:"scoreboard-time"},Me={class:"scoreboard-table"},Oe={class:"scoreboard-name"},Pe={key:2,class:"game-over-overlay"},xe={class:"game-over-card panel-cs"},Ae={class:"game-over-title"},Ue={class:"stats-table"},Ve=5e3,Ke=ce({__name:"NetworkedGameView",setup(ze){const _=fe(),h=ye(),{fetchMap:J}=we(),{connect:Q,socket:r}=be(),g=_e(),{playShot:X,playReload:Y,playWinCt:Z,playWinTer:ee,playPickupAmmo:se,playPickupMedkit:le}=ne(),W=i(null);let t=null;const d=i({health:100,weapon:"usp",ammo:12,ammoReserve:24,kills:0,deaths:0,scoreCt:0,scoreT:0,credits:800,weapons:[null,"usp"],currentSlot:1,round:1,roundTimeLeft:180}),f=i(!1),D=i(null),{isFullscreen:E,toggle:G}=ae(D),B=i(null),S=i("dust2"),v=i(null),w=i([]),M=N(()=>[...w.value].slice(-6).reverse()),b=i(!1),T=i([]),oe=N(()=>[...T.value].sort((l,o)=>l.team!==o.team?l.team==="ct"?-1:1:o.kills-l.kills)),te=N(()=>v.value?[...v.value.players].sort((a,l)=>a.team!==l.team?a.team==="ct"?-1:1:l.kills-a.kills):[]);function O(){g.leaveRoom(),v.value=null,h.push({name:"lobby"})}async function P(){var o,m,A,U;B.value=_.params.roomId||null;const a=W.value;if(!a||!B.value){h.push({name:"lobby"});return}Q(),g.setupListeners();const l=g.currentRoom;if(l)S.value=l.map;else{const y=_.query.mapId;S.value=y||"dust2"}try{const y=await J(S.value),R=((o=r.value)==null?void 0:o.id)??"local";t=new ie({canvas:a,map:y,localPlayerId:R,networked:!0,onInput:e=>{var p;(p=r.value)==null||p.emit("player:move",{up:e.up??!1,down:e.down??!1,left:e.left??!1,right:e.right??!1,angle:e.angle})},onShoot:()=>{var e;return(e=r.value)==null?void 0:e.emit("player:shoot")},onReload:()=>{var e;return(e=r.value)==null?void 0:e.emit("player:reload")},onSwitchWeapon:e=>{var p;return(p=r.value)==null?void 0:p.emit("player:switchWeapon",e)},onOpenShop:()=>{f.value=!f.value},onHUDUpdate:e=>{d.value=e}});const V=e=>{T.value=e.players,t==null||t.setServerState(e.players,e.pickups,e.round!=null?{round:e.round,roundTimeLeft:e.roundTimeLeft??180,roundWins:e.roundWins}:void 0)},K=e=>{T.value=e.players,t==null||t.setServerState(e.players,e.pickups,e.round!=null?{round:e.round,roundTimeLeft:e.roundTimeLeft??180,roundWins:e.roundWins}:void 0)},z=e=>{e.type==="shot"?(e.weapon&&X(e.weapon),e.trail&&t&&t.addBulletTrail(e.trail.x1,e.trail.y1,e.trail.x2,e.trail.y2)):e.type==="reloadStart"?Y():e.type==="kill"?w.value.push({killerName:e.killerName??"?",victimName:e.victimName??"?",time:Date.now()}):e.type==="roundEnd"?e.winner==="ct"?Z():e.winner==="t"&&ee():e.type==="pickupAmmo"&&e.playerId===R?se():e.type==="pickupMedkit"&&e.playerId===R?le():e.type==="gameOver"&&e.winner&&e.players&&(v.value={winner:e.winner,players:e.players})};(m=r.value)==null||m.on("game:state",V),(A=r.value)==null||A.on("game:update",K),(U=r.value)==null||U.on("game:event",z),t.setFogOfWar(!0),t.start(),H(()=>{var e,p,q;(e=r.value)==null||e.off("game:state",V),(p=r.value)==null||p.off("game:update",K),(q=r.value)==null||q.off("game:event",z)})}catch(y){console.error("Failed to init networked game:",y),h.push({name:"lobby"})}}let I=null;function x(a){a.code==="Tab"?(a.preventDefault(),b.value=!b.value):a.code==="Escape"&&(b.value=!1)}return de(()=>{P(),I=setInterval(()=>{const a=Date.now();w.value=w.value.filter(l=>a-l.time<Ve)},500),window.addEventListener("keydown",x)}),H(()=>{window.removeEventListener("keydown",x),I&&clearInterval(I),t==null||t.stop(),t=null}),pe(()=>_.params.roomId,()=>{t==null||t.stop(),P()}),(a,l)=>(c(),u("div",he,[s("div",ge,[l[3]||(l[3]=s("h2",null,"Сетевая игра",-1)),l[4]||(l[4]=s("p",{class:"hint"},"WASD — движение, мышь — прицел, ЛКМ — стрельба, R — перезарядка, 1/2 — оружие, B — магазин",-1)),s("div",Se,[s("button",{type:"button",class:"btn-cs",onClick:O},"Выйти"),s("button",{type:"button",class:"btn-fullscreen",title:k(E)?"Выйти из полноэкранного режима":"На весь экран",onClick:l[0]||(l[0]=(...o)=>k(G)&&k(G)(...o))},n(k(E)?"⊡":"⊞"),9,Te)])]),s("div",{ref_key:"canvasWrapRef",ref:D,class:"game-canvas-wrap"},[s("canvas",{ref_key:"canvasRef",ref:W,class:"game-canvas"},null,512),M.value.length?(c(),u("div",Ie,[(c(!0),u(C,null,L(M.value,(o,m)=>(c(),u("div",{key:m,class:"kill-feed-entry"},[s("span",Re,n(o.killerName),1),l[5]||(l[5]=s("span",{class:"kill-feed-sep"}," → ",-1)),s("span",Ce,n(o.victimName),1)]))),128))])):F("",!0),b.value?(c(),u("div",Le,[s("div",Fe,[s("div",Ne,[s("span",We,[s("span",De,n(d.value.scoreCt),1),l[6]||(l[6]=s("span",{class:"scoreboard-sep"},":",-1)),s("span",Ee,n(d.value.scoreT),1)]),s("span",Ge,"Раунд "+n(d.value.round),1),s("span",Be,n(Math.floor((d.value.roundTimeLeft??0)/60))+":"+n(String((d.value.roundTimeLeft??0)%60).padStart(2,"0")),1)]),s("div",Me,[l[7]||(l[7]=s("div",{class:"scoreboard-row scoreboard-head"},[s("span",null,"Игрок"),s("span",null,"K"),s("span",null,"D")],-1)),(c(!0),u(C,null,L(oe.value,o=>(c(),u("div",{key:o.id,class:j(["scoreboard-row",o.team])},[s("span",Oe,n(o.username),1),s("span",null,n(o.kills),1),s("span",null,n(o.deaths),1)],2))),128))]),l[8]||(l[8]=s("p",{class:"scoreboard-hint"},"TAB или ESC — закрыть",-1))])])):F("",!0),$(re,me(ve(d.value)),null,16),$(ue,{show:f.value,credits:d.value.credits,weapons:d.value.weapons,onClose:l[1]||(l[1]=o=>f.value=!1),onBuy:l[2]||(l[2]=o=>{var m;(m=k(r))==null||m.emit("player:buy",o),f.value=!1})},null,8,["show","credits","weapons"]),v.value?(c(),u("div",Pe,[s("div",xe,[s("h2",Ae,n(v.value.winner==="ct"?"CT":"T")+" ПОБЕДИЛИ!",1),s("div",Ue,[l[9]||(l[9]=s("div",{class:"stats-header"},[s("span",null,"Игрок"),s("span",null,"Команда"),s("span",null,"K"),s("span",null,"D")],-1)),(c(!0),u(C,null,L(te.value,o=>(c(),u("div",{key:o.id,class:j(["stats-row",o.team])},[s("span",null,n(o.username),1),s("span",null,n(o.team==="ct"?"CT":"T"),1),s("span",null,n(o.kills),1),s("span",null,n(o.deaths),1)],2))),128))]),s("button",{type:"button",class:"btn-cs btn-cs-primary",onClick:O}," Выход ")])])):F("",!0)],512)]))}}),Je=ke(Ke,[["__scopeId","data-v-862997da"]]);export{Je as default};
