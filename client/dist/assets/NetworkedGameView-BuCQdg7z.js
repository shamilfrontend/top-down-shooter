import{a as M,G as N,S as V,b as A}from"./ShopModal-CAlRZnEr.js";import{d as D,p as F,q as G,n as O,c as P,a as p,f as T,z as q,A as z,b as H,m as i,B as $,g as j,o as J,_ as K}from"./index-BjcpxiQA.js";import{u as Q}from"./MapRenderer-7N1qoh_1.js";import{a as X,u as Y}from"./room-V_12ESKf.js";const Z={class:"game-view"},ee={class:"game-canvas-wrap"},oe=D({__name:"NetworkedGameView",setup(se){const c=$(),f=j(),{fetchMap:b}=Q(),{connect:B,socket:s}=X(),w=Y(),{playShot:L,playReload:x,playWinCt:U,playWinTer:C}=M(),y=i(null);let o=null;const m=i({health:100,weapon:"usp",ammo:12,ammoReserve:24,kills:0,deaths:0,scoreCt:0,scoreT:0,credits:800,weapons:[null,"usp"],currentSlot:1,round:1,roundTimeLeft:180}),t=i(!1),h=i(null),d=i("dust2");async function S(){var l,r,k,g;h.value=c.params.roomId||null;const v=y.value;if(!v||!h.value){f.push({name:"lobby"});return}B(),w.setupListeners();const a=w.currentRoom;if(a)d.value=a.map;else{const u=c.query.mapId;d.value=u||"dust2"}try{const u=await b(d.value),E=((l=s.value)==null?void 0:l.id)??"local";o=new A({canvas:v,map:u,localPlayerId:E,networked:!0,onInput:e=>{var n;(n=s.value)==null||n.emit("player:move",{up:e.up??!1,down:e.down??!1,left:e.left??!1,right:e.right??!1,angle:e.angle})},onShoot:()=>{var e;return(e=s.value)==null?void 0:e.emit("player:shoot")},onReload:()=>{var e;return(e=s.value)==null?void 0:e.emit("player:reload")},onSwitchWeapon:e=>{var n;return(n=s.value)==null?void 0:n.emit("player:switchWeapon",e)},onOpenShop:()=>{t.value=!t.value},onHUDUpdate:e=>{m.value=e}});const R=e=>{o==null||o.setServerState(e.players,e.pickups,e.round!=null?{round:e.round,roundTimeLeft:e.roundTimeLeft??180,roundWins:e.roundWins}:void 0)},_=e=>{o==null||o.setServerState(e.players,e.pickups,e.round!=null?{round:e.round,roundTimeLeft:e.roundTimeLeft??180,roundWins:e.roundWins}:void 0)},I=e=>{e.type==="shot"?(e.weapon&&L(e.weapon),e.trail&&o&&o.addBulletTrail(e.trail.x1,e.trail.y1,e.trail.x2,e.trail.y2)):e.type==="reloadStart"?x():e.type==="roundEnd"&&(e.winner==="ct"?U():e.winner==="t"&&C())};(r=s.value)==null||r.on("game:state",R),(k=s.value)==null||k.on("game:update",_),(g=s.value)==null||g.on("game:event",I),o.setFogOfWar(!0),o.start(),G(()=>{var e,n,W;(e=s.value)==null||e.off("game:state",R),(n=s.value)==null||n.off("game:update",_),(W=s.value)==null||W.off("game:event",I)})}catch(u){console.error("Failed to init networked game:",u),f.push({name:"lobby"})}}return F(S),G(()=>{o==null||o.stop(),o=null}),O(()=>c.params.roomId,()=>{o==null||o.stop(),S()}),(v,a)=>(J(),P("div",Z,[a[2]||(a[2]=p("div",{class:"game-header"},[p("h2",null,"Сетевая игра"),p("p",{class:"hint"},"WASD — движение, мышь — прицел, ЛКМ — стрельба, R — перезарядка, 1/2 — оружие, B — магазин")],-1)),p("div",ee,[p("canvas",{ref_key:"canvasRef",ref:y,class:"game-canvas"},null,512),T(N,q(z(m.value)),null,16),T(V,{show:t.value,credits:m.value.credits,weapons:m.value.weapons,onClose:a[0]||(a[0]=l=>t.value=!1),onBuy:a[1]||(a[1]=l=>{var r;(r=H(s))==null||r.emit("player:buy",l),t.value=!1})},null,8,["show","credits","weapons"])])]))}}),re=K(oe,[["__scopeId","data-v-0c470593"]]);export{re as default};
