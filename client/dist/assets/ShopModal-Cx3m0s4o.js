var Q=Object.defineProperty;var ee=(o,e,n)=>e in o?Q(o,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):o[e]=n;var m=(o,e,n)=>ee(o,typeof e!="symbol"?e+"":e,n);import{x as te,p as se,d as q,c as R,a as y,t as g,e as Y,E as U,F as N,l as V,h as ne,o as k,n as Z,_ as j,y as ae,i as ie,T as oe}from"./index-Exz2pSih.js";import{M as le}from"./MapRenderer-DylprqHG.js";const ce=["usp"],re=["ak47","m4"];function D(o){const e=new Audio(o);return e.preload="auto",e}function Ze(){const o=D("/audio/shot-gun.mp3"),e=D("/audio/shot-machine-gun.mp3"),n=D("/audio/reloading.mp3"),i=D("/audio/win-ct.mp3"),l=D("/audio/win-ter.mp3");function a(r){ce.includes(r)?(o.currentTime=0,o.play().catch(()=>{})):re.includes(r)&&(e.currentTime=0,e.play().catch(()=>{}))}function s(){n.currentTime=0,n.play().catch(()=>{})}function h(){i.currentTime=0,i.play().catch(()=>{})}function d(){l.currentTime=0,l.play().catch(()=>{})}return{playShot:a,playReload:s,playWinCt:h,playWinTer:d}}function je(o){const e=se(!1);function n(){var r,v;const s=o.value;if(!s)return;const h=document;if(h.fullscreenElement??h.webkitFullscreenElement)return;const d=((r=s.requestFullscreen)==null?void 0:r.call(s))??((v=s.webkitRequestFullscreen)==null?void 0:v.call(s));d&&d.then(()=>{e.value=!0}).catch(()=>{})}function i(){var d,r;const s=document;if(!(s.fullscreenElement??s.webkitFullscreenElement))return;const h=((d=s.exitFullscreen)==null?void 0:d.call(s))??((r=s.webkitExitFullscreen)==null?void 0:r.call(s));h&&h.then(()=>{e.value=!1}).catch(()=>{})}function l(){e.value?i():n()}function a(){const s=document;e.value=!!(s.fullscreenElement??s.webkitFullscreenElement)}return typeof document<"u"&&(document.addEventListener("fullscreenchange",a),document.addEventListener("webkitfullscreenchange",a),te(()=>{document.removeEventListener("fullscreenchange",a),document.removeEventListener("webkitfullscreenchange",a)})),{isFullscreen:e,enter:n,exit:i,toggle:l}}const x=23,he={crate:30,barrel:20},F=2200,B=5e3,$=.85,de=.008;function z(o,e,n,i,l,a,s){const h=Math.max(i,Math.min(o,i+a)),d=Math.max(l,Math.min(e,l+s)),r=o-h,v=e-d;return r*r+v*v<=n*n}function K(o,e,n,i){const{x:l,y:a,width:s,height:h}=i,d=Math.max(l,Math.min(o,l+s)),r=Math.max(a,Math.min(e,a+h)),v=o-d,f=e-r,t=v*v+f*f;if(t===0||t>=n*n)return{x:o,y:e};const c=Math.sqrt(t),S=n-c+.5,u=v/c,w=f/c;return{x:o+u*S,y:e+w*S}}function ue(o,e,n,i,l,a,s){const h=(l.right?1:0)-(l.left?1:0),d=(l.down?1:0)-(l.up?1:0),r=Math.sqrt(h*h+d*d),v=r>0?h/r:0,f=r>0?d/r:0;let t=n+v*B*s,c=i+f*B*s;const S=Math.sqrt(t*t+c*c);S>F&&(t=t/S*F,c=c/S*F),t*=$,c*=$;let u=o+t*s,w=e+c*s;u=Math.max(x,Math.min(a.width-x,u)),w=Math.max(x,Math.min(a.height-x,w));for(const b of a.walls)if(z(u,w,x,b.x,b.y,b.width,b.height)){const P=K(u,w,x,b);u=P.x,w=P.y;const T=Math.max(b.x,Math.min(u,b.x+b.width)),E=Math.max(b.y,Math.min(w,b.y+b.height)),M=(u-T)/x,I=(w-E)/x,A=t*M+c*I;A<0&&(t-=A*M*1.2,c-=A*I*1.2)}for(const b of a.obstacles){const P=he[b.type]??25,T=b.x,E=b.y,M=P,I=P;if(z(u,w,x,T,E,M,I)){const A=K(u,w,x,{x:T,y:E,width:M,height:I});u=A.x,w=A.y;const X=Math.max(T,Math.min(u,T+M)),p=Math.max(E,Math.min(w,E+I)),L=(u-X)/x,C=(w-p)/x,_=t*L+c*C;_<0&&(t-=_*L*1.2,c-=_*C*1.2)}}return{x:u,y:w,vx:t,vy:c}}function me(o,e,n,i){let{x:l,y:a,vx:s,vy:h,angle:d}=o,r=i;for(;r>0;){const v=Math.min(r,de),f=ue(l,a,s,h,e,n,v);l=f.x,a=f.y,s=f.vx,h=f.vy,r-=v}return{x:l,y:a,vx:s,vy:h,angle:d}}const fe=150;class ye{constructor(e){m(this,"buffer",[]);m(this,"getLerpValue");this.getLerpValue=e}add(e){const n=performance.now();for(this.buffer.push({data:e,timestamp:n});this.buffer.length>2&&n-this.buffer[0].timestamp>fe;)this.buffer.shift()}get(e=80){if(this.buffer.length===0)return null;const i=performance.now()-e;let l=this.buffer[0],a=this.buffer[1];if(!a||i>=a.timestamp)return this.buffer[this.buffer.length-1].data;if(i<=l.timestamp)return l.data;const s=(i-l.timestamp)/(a.timestamp-l.timestamp);return this.getLerpValue(l.data,a.data,s)}}const O=756,G=.1,H={usp:{len:20,width:3,color:"#aaa"},ak47:{len:30,width:3.5,color:"#8B7355"},m4:{len:28,width:3.5,color:"#666"}};class Je{constructor(e){m(this,"canvas");m(this,"ctx");m(this,"map");m(this,"mapRenderer");m(this,"localPlayerId");m(this,"onInput");m(this,"onShoot");m(this,"onReload");m(this,"onSwitchWeapon");m(this,"onOpenShop");m(this,"onHUDUpdate");m(this,"localState");m(this,"players",[]);m(this,"serverPlayers",new Map);m(this,"lastServerState",[]);m(this,"pickups",[]);m(this,"input",{up:!1,down:!1,left:!1,right:!1});m(this,"mouseDown",!1);m(this,"mouseX",0);m(this,"mouseY",0);m(this,"cameraX",0);m(this,"cameraY",0);m(this,"scale",.5);m(this,"fogOfWar",!0);m(this,"lastTime",0);m(this,"rafId",null);m(this,"resizeObserver",null);m(this,"networked");m(this,"inputSendInterval",0);m(this,"bulletTrails",[]);m(this,"cleanupInput");m(this,"lastRoundInfo");m(this,"lastRoundWins");this.canvas=e.canvas;const n=this.canvas.getContext("2d");if(!n)throw new Error("Canvas 2d context not available");this.ctx=n,this.map=e.map,this.localPlayerId=e.localPlayerId,this.onInput=e.onInput,this.onShoot=e.onShoot,this.onReload=e.onReload,this.onSwitchWeapon=e.onSwitchWeapon,this.onOpenShop=e.onOpenShop,this.onHUDUpdate=e.onHUDUpdate,this.networked=!!e.networked;const i=this.canvas.getBoundingClientRect();this.mapRenderer=new le(n,this.map,i.width,i.height),this.scale=Math.min(i.width/this.map.width,i.height/this.map.height)*.85;const l=this.map.spawnPoints.ct[0]||{x:100,y:100};this.localState={x:l.x+30,y:l.y+30,vx:0,vy:0,angle:0},this.cameraX=this.localState.x,this.cameraY=this.localState.y,this.setupInput()}setupInput(){const e=s=>{var d,r,v,f;if(s.code==="Tab"||s.code==="Escape")return;const h=s.repeat;switch(s.code){case"KeyW":this.input.up=!0;break;case"KeyS":this.input.down=!0;break;case"KeyA":this.input.left=!0;break;case"KeyD":this.input.right=!0;break;case"KeyR":h||(d=this.onReload)==null||d.call(this);break;case"KeyB":h||(r=this.onOpenShop)==null||r.call(this);break;case"Digit1":h||(v=this.onSwitchWeapon)==null||v.call(this,0);break;case"Digit2":h||(f=this.onSwitchWeapon)==null||f.call(this,1);break}},n=s=>{switch(s.code){case"KeyW":this.input.up=!1;break;case"KeyS":this.input.down=!1;break;case"KeyA":this.input.left=!1;break;case"KeyD":this.input.right=!1;break}},i=s=>{s.button===0&&(this.mouseDown=!0)},l=s=>{s.button===0&&(this.mouseDown=!1)},a=s=>{const h=this.canvas.getBoundingClientRect();this.mouseX=s.clientX-h.left,this.mouseY=s.clientY-h.top};window.addEventListener("keydown",e),window.addEventListener("keyup",n),this.canvas.addEventListener("mousemove",a),this.canvas.addEventListener("mousedown",i),window.addEventListener("mouseup",l),this.cleanupInput=()=>{window.removeEventListener("keydown",e),window.removeEventListener("keyup",n),this.canvas.removeEventListener("mousemove",a),this.canvas.removeEventListener("mousedown",i),window.removeEventListener("mouseup",l)}}setPlayers(e){this.players=e}setServerState(e,n,i){n&&(this.pickups=n),i&&this.setRoundInfo(i.round,i.roundTimeLeft,i.roundWins),this.lastServerState=e;const l=(a,s,h)=>{let d=s.angle-a.angle;for(;d>Math.PI;)d-=Math.PI*2;for(;d<-Math.PI;)d+=Math.PI*2;return{...s,x:a.x+(s.x-a.x)*h,y:a.y+(s.y-a.y)*h,angle:a.angle+d*h}};e.forEach(a=>{let s=this.serverPlayers.get(a.id);s||(s=new ye(l),this.serverPlayers.set(a.id,s)),s.add(a)})}addBulletTrail(e,n,i,l){this.bulletTrails.push({x1:e,y1:n,x2:i,y2:l,time:performance.now()})}setLocalPosition(e,n,i){this.localState.x=e,this.localState.y=n,this.localState.vx=0,this.localState.vy=0,i!==void 0&&(this.localState.angle=i)}setFogOfWar(e){this.fogOfWar=e}getLocalPlayerState(){const e=this.lastServerState.find(n=>n.id===this.localPlayerId);return e?{health:e.health,weapon:e.weapon,ammo:e.ammo,ammoReserve:e.ammoReserve,kills:e.kills,deaths:e.deaths,credits:e.credits,weapons:e.weapons,currentSlot:e.currentSlot}:null}getRoundInfo(){return this.lastRoundInfo??null}setRoundInfo(e,n,i){this.lastRoundInfo={round:e,roundTimeLeft:n},i&&(this.lastRoundWins=i)}getScore(){if(this.lastRoundWins)return{...this.lastRoundWins};let e=0,n=0;for(const i of this.lastServerState)i.team==="ct"?e+=i.kills:n+=i.kills;return{ct:e,t:n}}resize(){const e=this.canvas.getBoundingClientRect(),n=window.devicePixelRatio||1;this.canvas.width=e.width*n,this.canvas.height=e.height*n,this.ctx.scale(n,n),this.mapRenderer.setSize(e.width,e.height)}tick(e){var s,h,d;const n=Math.min((e-this.lastTime)/1e3,.1);this.lastTime=e;const[i,l]=this.mapRenderer.screenToWorld(this.mouseX,this.mouseY),a=Math.atan2(l-this.localState.y,i-this.localState.x);if(this.mouseDown&&((s=this.onShoot)==null||s.call(this)),!this.networked)this.localState=me(this.localState,this.input,this.map,n),this.localState.angle=a;else{const r=this.lastServerState.find(v=>v.id===this.localPlayerId);r&&(this.localState.x=r.x,this.localState.y=r.y,this.localState.angle=r.angle),this.localState.angle=a,this.inputSendInterval+=n,this.inputSendInterval>=.05&&(this.inputSendInterval=0,(h=this.onInput)==null||h.call(this,{x:this.localState.x,y:this.localState.y,angle:a,up:this.input.up,down:this.input.down,left:this.input.left,right:this.input.right}))}if(this.cameraX+=(this.localState.x-this.cameraX)*G,this.cameraY+=(this.localState.y-this.cameraY)*G,this.mapRenderer.setCamera(this.cameraX,this.cameraY,this.scale),this.networked&&this.onHUDUpdate){const r=this.getLocalPlayerState(),v=this.getScore(),f=this.getRoundInfo();r&&this.onHUDUpdate({...r,scoreCt:v.ct,scoreT:v.t,round:f==null?void 0:f.round,roundTimeLeft:f==null?void 0:f.roundTimeLeft})}this.render(),this.networked||(d=this.onInput)==null||d.call(this,{x:this.localState.x,y:this.localState.y,angle:this.localState.angle}),this.rafId=requestAnimationFrame(r=>this.tick(r))}render(){const{ctx:e,map:n,mapRenderer:i,localState:l,players:a}=this,s=l.x,h=l.y,d=this.scale;if(i.render(),i.renderPickups(this.pickups),e.save(),i.applyWorldTransform(e),this.fogOfWar){e.fillStyle="rgba(0,0,0,0.85)",e.beginPath(),e.rect(-1e3,-1e3,n.width+2e3,n.height+2e3),e.arc(s,h,O,0,Math.PI*2),e.fill("evenodd");const t=e.createRadialGradient(s,h,O*.3,s,h,O);t.addColorStop(0,"rgba(0,0,0,0)"),t.addColorStop(.6,"rgba(0,0,0,0.2)"),t.addColorStop(1,"rgba(0,0,0,0.85)"),e.fillStyle=t,e.fillRect(-1e3,-1e3,n.width+2e3,n.height+2e3)}let r;if(this.networked){const t=[];this.serverPlayers.forEach((S,u)=>{if(u===this.localPlayerId)return;const w=S.get(80);w&&t.push({...w,userId:void 0,ammoReserve:w.ammoReserve,isLocal:!1})});const c=this.lastServerState.find(S=>S.id===this.localPlayerId);r=[...t,{id:this.localPlayerId,username:(c==null?void 0:c.username)??"You",team:(c==null?void 0:c.team)??"ct",x:l.x,y:l.y,angle:l.angle,health:(c==null?void 0:c.health)??100,weapon:(c==null?void 0:c.weapon)??"usp",ammo:(c==null?void 0:c.ammo)??0,ammoReserve:(c==null?void 0:c.ammoReserve)??0,isAlive:(c==null?void 0:c.isAlive)??!0,kills:(c==null?void 0:c.kills)??0,deaths:(c==null?void 0:c.deaths)??0,isLocal:!0}]}else r=[...a.filter(t=>t.id!==this.localPlayerId),{...l,id:this.localPlayerId,username:"You",team:"ct",x:l.x,y:l.y,angle:l.angle,health:100,weapon:"usp",ammo:0,ammoReserve:0,isAlive:!0,kills:0,deaths:0,isLocal:!0}];const v=performance.now(),f=120;this.bulletTrails=this.bulletTrails.filter(t=>v-t.time<f),this.bulletTrails.forEach(t=>{const c=(v-t.time)/f,S=.5*(1-c);e.strokeStyle=`rgba(255, 220, 100, ${S})`,e.lineWidth=(1.5-c)/d,e.beginPath(),e.moveTo(t.x1,t.y1),e.lineTo(t.x2,t.y2),e.stroke()}),r.forEach(t=>{if(!(!this.fogOfWar||this.isVisible(s,h,t.x,t.y)))return;const S=t.team==="ct",u=x;t.isAlive&&(e.fillStyle="rgba(0,0,0,0.25)",e.beginPath(),e.ellipse(t.x+3,t.y+3,u*1.05,u*.8,0,0,Math.PI*2),e.fill());const w=H[t.weapon]??H.usp,P=t.angle+.15,T=t.x+Math.cos(P)*u*.5,E=t.y+Math.sin(P)*u*.5,M=t.x+Math.cos(t.angle)*(u+w.len),I=t.y+Math.sin(t.angle)*(u+w.len);t.isAlive&&(e.strokeStyle=w.color,e.lineWidth=w.width/d,e.lineCap="round",e.beginPath(),e.moveTo(T,E),e.lineTo(M,I),e.stroke(),e.lineCap="butt",t.weapon&&(e.fillStyle="#333",e.beginPath(),e.arc(M,I,1.5/d,0,Math.PI*2),e.fill()));const A=t.isAlive?S?"#3b7dd8":"#d04040":"#3a3a3a",X=t.isAlive?S?"#2b5da8":"#a03030":"#2a2a2a";if(e.fillStyle=X,e.beginPath(),e.arc(t.x,t.y,u+1.5/d,0,Math.PI*2),e.fill(),e.fillStyle=A,e.beginPath(),e.arc(t.x,t.y,u,0,Math.PI*2),e.fill(),t.isAlive){const p=e.createRadialGradient(t.x-u*.3,t.y-u*.3,u*.1,t.x,t.y,u);p.addColorStop(0,"rgba(255,255,255,0.25)"),p.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=p,e.beginPath(),e.arc(t.x,t.y,u,0,Math.PI*2),e.fill()}if(t.isLocal&&t.isAlive&&(e.strokeStyle="rgba(255,255,255,0.6)",e.lineWidth=1.5/d,e.beginPath(),e.arc(t.x,t.y,u+.5/d,0,Math.PI*2),e.stroke()),t.isAlive){const p=u*.7,L=t.x+Math.cos(t.angle)*(u*.5),C=t.y+Math.sin(t.angle)*(u*.5),_=L+Math.cos(t.angle)*p,W=C+Math.sin(t.angle)*p;e.strokeStyle="rgba(255,255,255,0.7)",e.lineWidth=2/d,e.beginPath(),e.moveTo(L,C),e.lineTo(_,W),e.stroke()}if(t.isAlive&&t.health<100){const p=u*2.2,L=3,C=t.x-p/2,_=t.y-u-10;e.fillStyle="rgba(0,0,0,0.5)",e.fillRect(C,_,p,L);const W=Math.max(0,t.health/100),J=W>.5?"#4caf50":W>.25?"#ff9800":"#f44336";e.fillStyle=J,e.fillRect(C,_,p*W,L)}if(t.isAlive&&(e.fillStyle=S?"rgba(120,180,255,0.85)":"rgba(255,130,130,0.85)",e.font="bold 9px sans-serif",e.textAlign="center",e.textBaseline="bottom",e.fillText(t.username,t.x,t.y-u-12)),!t.isAlive){e.strokeStyle="#666",e.lineWidth=2/d;const p=u*.5;e.beginPath(),e.moveTo(t.x-p,t.y-p),e.lineTo(t.x+p,t.y+p),e.moveTo(t.x+p,t.y-p),e.lineTo(t.x-p,t.y+p),e.stroke()}}),e.restore()}isVisible(e,n,i,l){const a=i-e,s=l-n;return a*a+s*s<=O*O}start(){this.resize(),this.resizeObserver=new ResizeObserver(()=>this.resize()),this.resizeObserver.observe(this.canvas),this.lastTime=performance.now(),this.rafId=requestAnimationFrame(e=>this.tick(e))}stop(){var e,n;(e=this.resizeObserver)==null||e.disconnect(),this.resizeObserver=null,this.rafId!==null&&(cancelAnimationFrame(this.rafId),this.rafId=null),(n=this.cleanupInput)==null||n.call(this)}}const ve={class:"hud"},we={class:"hud-top"},pe={class:"score"},ge={class:"team-ct"},Se={class:"team-t"},be={key:0,class:"credits-bar"},xe={key:1,class:"round-info"},ke={key:0,class:"round-timer"},Me={class:"hud-bottom"},Ie={class:"hud-left"},Re={class:"hp-bar"},Pe={class:"hp-text"},Te={class:"weapon-slots"},Ee={class:"slot-key"},Ae={key:1,class:"slot-icon-empty"},Le={class:"weapon-info"},Ce={class:"weapon-name"},_e={class:"ammo"},We={class:"hud-right"},De={class:"stats"},Oe={class:"stat"},Ye={class:"stat"},Xe=q({__name:"GameHUD",props:{health:{},weapon:{},ammo:{},ammoReserve:{},kills:{},deaths:{},scoreCt:{},scoreT:{},credits:{},weapons:{},currentSlot:{},round:{},roundTimeLeft:{}},setup(o){var h,d;const e=o,n={usp:"USP-S",ak47:"AK-47",m4:"M4A1"},i={usp:20,ak47:28,m4:26},l=[{key:0,label:"1",weapon:((h=e.weapons)==null?void 0:h[0])??null},{key:1,label:"2",weapon:((d=e.weapons)==null?void 0:d[1])??"usp"}];function a(r){var f;return((f=e.weapons)==null?void 0:f[r])??null}function s(r){return(e.currentSlot??1)===r}return(r,v)=>(k(),R("div",ve,[y("div",we,[y("div",pe,[y("span",ge,g(o.scoreCt),1),v[0]||(v[0]=y("span",{class:"sep"},":",-1)),y("span",Se,g(o.scoreT),1)]),o.credits!=null?(k(),R("div",be," $"+g(o.credits),1)):Y("",!0),o.round!=null?(k(),R("div",xe,[y("span",null,"Раунд "+g(o.round),1),o.roundTimeLeft!=null?(k(),R("span",ke,g(Math.floor((o.roundTimeLeft??0)/60))+":"+g(String((o.roundTimeLeft??0)%60).padStart(2,"0")),1)):Y("",!0)])):Y("",!0)]),y("div",Me,[y("div",Ie,[y("div",Re,[y("div",{class:"hp-fill",style:U({width:`${o.health}%`})},null,4),y("span",Pe,g(o.health)+" HP",1)]),y("div",Te,[(k(),R(N,null,V(l,f=>y("div",{key:f.key,class:Z(["weapon-slot",{selected:s(f.key),empty:!a(f.key)}])},[y("span",Ee,g(f.label),1),a(f.key)?(k(),R("span",{key:0,class:"slot-icon-bar",style:U({width:(i[a(f.key)]??18)+"px"})},null,4)):(k(),R("span",Ae,"—"))],2)),64))]),y("div",Le,[y("span",Ce,[y("span",{class:"weapon-icon-bar",style:U({width:(i[o.weapon]??18)+"px"})},null,4),ne(" "+g(n[o.weapon]??o.weapon),1)]),y("span",_e,g(o.ammo)+" / "+g(o.ammoReserve),1)])]),y("div",We,[y("div",De,[y("span",Oe,"K: "+g(o.kills),1),y("span",Ye,"D: "+g(o.deaths),1)])])])]))}}),Qe=j(Xe,[["__scopeId","data-v-80f8560d"]]),Ue={class:"shop-modal panel-cs"},Fe={class:"shop-header"},Be={class:"credits"},$e={class:"shop-items"},ze={class:"item-name"},Ke={class:"item-price"},Ge=["disabled","onClick"],He=q({__name:"ShopModal",props:{show:{type:Boolean},credits:{},weapons:{}},emits:["close","buy"],setup(o,{emit:e}){const n=e,i=[{id:"ak47",name:"AK-47",price:2700,slot:0},{id:"m4",name:"M4A1",price:3100,slot:0}];return(l,a)=>(k(),ae(oe,{to:"body"},[o.show?(k(),R("div",{key:0,class:"shop-overlay",onClick:a[0]||(a[0]=ie(s=>n("close"),["self"]))},[y("div",Ue,[y("div",Fe,[a[1]||(a[1]=y("h3",{class:"shop-title"},"МАГАЗИН",-1)),y("span",Be,"$"+g(o.credits),1)]),y("div",$e,[(k(),R(N,null,V(i,s=>y("div",{key:s.id,class:Z(["shop-item",{disabled:o.credits<s.price||o.weapons[0]}])},[y("div",ze,g(s.name),1),y("div",Ke,"$"+g(s.price),1),y("button",{type:"button",class:"btn-cs btn-cs-primary btn-buy",disabled:o.credits<s.price||!!o.weapons[0],onClick:h=>n("buy",s.id)},g(o.weapons[0]?"Куплено":o.credits<s.price?"Недостаточно":"Купить"),9,Ge)],2)),64))]),a[2]||(a[2]=y("p",{class:"shop-hint"},"B — закрыть",-1))])])):Y("",!0)]))}}),et=j(He,[["__scopeId","data-v-5c2661ad"]]);export{Qe as G,et as S,Ze as a,je as b,Je as c,me as u};
