var J=Object.defineProperty;var Q=(l,t,s)=>t in l?J(l,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):l[t]=s;var h=(l,t,s)=>Q(l,typeof t!="symbol"?t+"":t,s);import{M as tt}from"./MapRenderer-7N1qoh_1.js";import{d as N,c as P,a as u,t as S,e as Y,D as U,F as V,l as q,h as et,o as b,y as z,_ as Z,s as st,i as at,T as nt}from"./index-BjcpxiQA.js";const ot=["usp"],it=["ak47","m4"];function W(l){const t=new Audio(l);return t.preload="auto",t}function Nt(){const l=W("/audio/shot-gun.mp3"),t=W("/audio/shot-machine-gun.mp3"),s=W("/audio/reloading.mp3"),i=W("/audio/win-ct.mp3"),o=W("/audio/win-ter.mp3");function n(d){ot.includes(d)?(l.currentTime=0,l.play().catch(()=>{})):it.includes(d)&&(t.currentTime=0,t.play().catch(()=>{}))}function a(){s.currentTime=0,s.play().catch(()=>{})}function c(){i.currentTime=0,i.play().catch(()=>{})}function m(){o.currentTime=0,o.play().catch(()=>{})}return{playShot:n,playReload:a,playWinCt:c,playWinTer:m}}const x=23,lt={crate:30,barrel:20},ct=1120,B=5e3,$=.85;function K(l,t,s,i,o,n,a){const c=Math.max(i,Math.min(l,i+n)),m=Math.max(o,Math.min(t,o+a)),d=l-c,p=t-m;return d*d+p*p<=s*s}function G(l,t,s,i){const{x:o,y:n,width:a,height:c}=i,m=Math.max(o,Math.min(l,o+a)),d=Math.max(n,Math.min(t,n+c)),p=l-m,y=t-d,e=p*p+y*y;if(e===0||e>=s*s)return{x:l,y:t};const r=Math.sqrt(e),g=s-r,f=p/r,w=y/r;return{x:l+f*g,y:t+w*g}}function rt(l,t,s,i){let{x:o,y:n,vx:a,vy:c,angle:m}=l;const d=(t.right?1:0)-(t.left?1:0),p=(t.down?1:0)-(t.up?1:0),y=Math.sqrt(d*d+p*p),e=y>0?d/y:0,r=y>0?p/y:0;a+=e*B*i,c+=r*B*i;const g=ct,f=Math.sqrt(a*a+c*c);f>g&&(a=a/f*g,c=c/f*g),a*=$,c*=$,o+=a*i,n+=c*i,o=Math.max(x,Math.min(s.width-x,o)),n=Math.max(x,Math.min(s.height-x,n));for(const w of s.walls)if(K(o,n,x,w.x,w.y,w.width,w.height)){const C=G(o,n,x,w);o=C.x,n=C.y;const k=Math.max(w.x,Math.min(o,w.x+w.width)),T=Math.max(w.y,Math.min(n,w.y+w.height)),A=(o-k)/x,M=(n-T)/x,I=a*A+c*M;I<0&&(a-=I*A*1.2,c-=I*M*1.2)}for(const w of s.obstacles){const C=lt[w.type]??25,k=w.x,T=w.y,A=C,M=C;if(K(o,n,x,k,T,A,M)){const I=G(o,n,x,{x:k,y:T,width:A,height:M});o=I.x,n=I.y;const X=Math.max(k,Math.min(o,k+A)),O=Math.max(T,Math.min(n,T+M)),v=(o-X)/x,L=(n-O)/x,R=a*v+c*L;R<0&&(a-=R*v*1.2,c-=R*L*1.2)}}return{x:o,y:n,vx:a,vy:c,angle:m}}const ht=150;class dt{constructor(t){h(this,"buffer",[]);h(this,"getLerpValue");this.getLerpValue=t}add(t){const s=performance.now();for(this.buffer.push({data:t,timestamp:s});this.buffer.length>2&&s-this.buffer[0].timestamp>ht;)this.buffer.shift()}get(t=80){if(this.buffer.length===0)return null;const i=performance.now()-t;let o=this.buffer[0],n=this.buffer[1];if(!n||i>=n.timestamp)return this.buffer[this.buffer.length-1].data;if(i<=o.timestamp)return o.data;const a=(i-o.timestamp)/(n.timestamp-o.timestamp);return this.getLerpValue(o.data,n.data,a)}}const _=756,F=.1,H={usp:{len:20,width:3,color:"#aaa"},ak47:{len:30,width:3.5,color:"#8B7355"},m4:{len:28,width:3.5,color:"#666"}};class Vt{constructor(t){h(this,"canvas");h(this,"ctx");h(this,"map");h(this,"mapRenderer");h(this,"localPlayerId");h(this,"onInput");h(this,"onShoot");h(this,"onReload");h(this,"onSwitchWeapon");h(this,"onOpenShop");h(this,"onHUDUpdate");h(this,"localState");h(this,"players",[]);h(this,"serverPlayers",new Map);h(this,"lastServerState",[]);h(this,"pickups",[]);h(this,"input",{up:!1,down:!1,left:!1,right:!1});h(this,"mouseDown",!1);h(this,"mouseX",0);h(this,"mouseY",0);h(this,"cameraX",0);h(this,"cameraY",0);h(this,"scale",.5);h(this,"fogOfWar",!0);h(this,"lastTime",0);h(this,"rafId",null);h(this,"networked");h(this,"inputSendInterval",0);h(this,"bulletTrails",[]);h(this,"cleanupInput");h(this,"lastRoundInfo");h(this,"lastRoundWins");this.canvas=t.canvas;const s=this.canvas.getContext("2d");if(!s)throw new Error("Canvas 2d context not available");this.ctx=s,this.map=t.map,this.localPlayerId=t.localPlayerId,this.onInput=t.onInput,this.onShoot=t.onShoot,this.onReload=t.onReload,this.onSwitchWeapon=t.onSwitchWeapon,this.onOpenShop=t.onOpenShop,this.onHUDUpdate=t.onHUDUpdate,this.networked=!!t.networked;const i=this.canvas.getBoundingClientRect();this.mapRenderer=new tt(s,this.map,i.width,i.height),this.scale=Math.min(i.width/this.map.width,i.height/this.map.height)*.85;const o=this.map.spawnPoints.ct[0]||{x:100,y:100};this.localState={x:o.x+30,y:o.y+30,vx:0,vy:0,angle:0},this.cameraX=this.localState.x,this.cameraY=this.localState.y,this.setupInput()}setupInput(){const t=a=>{var c,m,d,p;switch(a.code){case"KeyW":this.input.up=!0;break;case"KeyS":this.input.down=!0;break;case"KeyA":this.input.left=!0;break;case"KeyD":this.input.right=!0;break;case"KeyR":(c=this.onReload)==null||c.call(this);break;case"KeyB":(m=this.onOpenShop)==null||m.call(this);break;case"Digit1":(d=this.onSwitchWeapon)==null||d.call(this,0);break;case"Digit2":(p=this.onSwitchWeapon)==null||p.call(this,1);break}},s=a=>{switch(a.code){case"KeyW":this.input.up=!1;break;case"KeyS":this.input.down=!1;break;case"KeyA":this.input.left=!1;break;case"KeyD":this.input.right=!1;break}},i=a=>{a.button===0&&(this.mouseDown=!0)},o=a=>{a.button===0&&(this.mouseDown=!1)},n=a=>{const c=this.canvas.getBoundingClientRect();this.mouseX=a.clientX-c.left,this.mouseY=a.clientY-c.top};window.addEventListener("keydown",t),window.addEventListener("keyup",s),this.canvas.addEventListener("mousemove",n),this.canvas.addEventListener("mousedown",i),window.addEventListener("mouseup",o),this.cleanupInput=()=>{window.removeEventListener("keydown",t),window.removeEventListener("keyup",s),this.canvas.removeEventListener("mousemove",n),this.canvas.removeEventListener("mousedown",i),window.removeEventListener("mouseup",o)}}setPlayers(t){this.players=t}setServerState(t,s,i){s&&(this.pickups=s),i&&this.setRoundInfo(i.round,i.roundTimeLeft,i.roundWins),this.lastServerState=t;const o=(n,a,c)=>{let m=a.angle-n.angle;for(;m>Math.PI;)m-=Math.PI*2;for(;m<-Math.PI;)m+=Math.PI*2;return{...a,x:n.x+(a.x-n.x)*c,y:n.y+(a.y-n.y)*c,angle:n.angle+m*c}};t.forEach(n=>{let a=this.serverPlayers.get(n.id);a||(a=new dt(o),this.serverPlayers.set(n.id,a)),a.add(n)})}addBulletTrail(t,s,i,o){this.bulletTrails.push({x1:t,y1:s,x2:i,y2:o,time:performance.now()})}setLocalPosition(t,s,i){this.localState.x=t,this.localState.y=s,this.localState.vx=0,this.localState.vy=0,i!==void 0&&(this.localState.angle=i)}setFogOfWar(t){this.fogOfWar=t}getLocalPlayerState(){const t=this.lastServerState.find(s=>s.id===this.localPlayerId);return t?{health:t.health,weapon:t.weapon,ammo:t.ammo,ammoReserve:t.ammoReserve,kills:t.kills,deaths:t.deaths,credits:t.credits,weapons:t.weapons,currentSlot:t.currentSlot}:null}getRoundInfo(){return this.lastRoundInfo??null}setRoundInfo(t,s,i){this.lastRoundInfo={round:t,roundTimeLeft:s},i&&(this.lastRoundWins=i)}getScore(){if(this.lastRoundWins)return{...this.lastRoundWins};let t=0,s=0;for(const i of this.lastServerState)i.team==="ct"?t+=i.kills:s+=i.kills;return{ct:t,t:s}}resize(){const t=this.canvas.getBoundingClientRect(),s=window.devicePixelRatio||1;this.canvas.width=t.width*s,this.canvas.height=t.height*s,this.ctx.scale(s,s),this.mapRenderer.setSize(t.width,t.height)}tick(t){var a,c,m;const s=Math.min((t-this.lastTime)/1e3,.1);this.lastTime=t;const[i,o]=this.mapRenderer.screenToWorld(this.mouseX,this.mouseY),n=Math.atan2(o-this.localState.y,i-this.localState.x);if(this.mouseDown&&((a=this.onShoot)==null||a.call(this)),!this.networked)this.localState=rt(this.localState,this.input,this.map,s),this.localState.angle=n;else{const d=this.lastServerState.find(p=>p.id===this.localPlayerId);d&&(this.localState.x=d.x,this.localState.y=d.y,this.localState.angle=d.angle),this.localState.angle=n,this.inputSendInterval+=s,this.inputSendInterval>=.05&&(this.inputSendInterval=0,(c=this.onInput)==null||c.call(this,{x:this.localState.x,y:this.localState.y,angle:n,up:this.input.up,down:this.input.down,left:this.input.left,right:this.input.right}))}if(this.cameraX+=(this.localState.x-this.cameraX)*F,this.cameraY+=(this.localState.y-this.cameraY)*F,this.mapRenderer.setCamera(this.cameraX,this.cameraY,this.scale),this.networked&&this.onHUDUpdate){const d=this.getLocalPlayerState(),p=this.getScore(),y=this.getRoundInfo();d&&this.onHUDUpdate({...d,scoreCt:p.ct,scoreT:p.t,round:y==null?void 0:y.round,roundTimeLeft:y==null?void 0:y.roundTimeLeft})}this.render(),this.networked||(m=this.onInput)==null||m.call(this,{x:this.localState.x,y:this.localState.y,angle:this.localState.angle}),this.rafId=requestAnimationFrame(d=>this.tick(d))}render(){const{ctx:t,map:s,mapRenderer:i,localState:o,players:n}=this,a=o.x,c=o.y,m=this.scale;if(i.render(),i.renderPickups(this.pickups),t.save(),i.applyWorldTransform(t),this.fogOfWar){t.fillStyle="rgba(0,0,0,0.85)",t.beginPath(),t.rect(-1e3,-1e3,s.width+2e3,s.height+2e3),t.arc(a,c,_,0,Math.PI*2),t.fill("evenodd");const e=t.createRadialGradient(a,c,_*.3,a,c,_);e.addColorStop(0,"rgba(0,0,0,0)"),e.addColorStop(.6,"rgba(0,0,0,0.2)"),e.addColorStop(1,"rgba(0,0,0,0.85)"),t.fillStyle=e,t.fillRect(-1e3,-1e3,s.width+2e3,s.height+2e3)}let d;if(this.networked){const e=[];this.serverPlayers.forEach((g,f)=>{if(f===this.localPlayerId)return;const w=g.get(80);w&&e.push({...w,userId:void 0,ammoReserve:w.ammoReserve,isLocal:!1})});const r=this.lastServerState.find(g=>g.id===this.localPlayerId);d=[...e,{id:this.localPlayerId,username:(r==null?void 0:r.username)??"You",team:(r==null?void 0:r.team)??"ct",x:o.x,y:o.y,angle:o.angle,health:(r==null?void 0:r.health)??100,weapon:(r==null?void 0:r.weapon)??"usp",ammo:(r==null?void 0:r.ammo)??0,ammoReserve:(r==null?void 0:r.ammoReserve)??0,isAlive:(r==null?void 0:r.isAlive)??!0,kills:(r==null?void 0:r.kills)??0,deaths:(r==null?void 0:r.deaths)??0,isLocal:!0}]}else d=[...n.filter(e=>e.id!==this.localPlayerId),{...o,id:this.localPlayerId,username:"You",team:"ct",x:o.x,y:o.y,angle:o.angle,health:100,weapon:"usp",ammo:0,ammoReserve:0,isAlive:!0,kills:0,deaths:0,isLocal:!0}];const p=performance.now(),y=120;this.bulletTrails=this.bulletTrails.filter(e=>p-e.time<y),this.bulletTrails.forEach(e=>{const r=(p-e.time)/y,g=.5*(1-r);t.strokeStyle=`rgba(255, 220, 100, ${g})`,t.lineWidth=(1.5-r)/m,t.beginPath(),t.moveTo(e.x1,e.y1),t.lineTo(e.x2,e.y2),t.stroke()}),d.forEach(e=>{if(!(!this.fogOfWar||this.isVisible(a,c,e.x,e.y)))return;const g=e.team==="ct",f=x;e.isAlive&&(t.fillStyle="rgba(0,0,0,0.25)",t.beginPath(),t.ellipse(e.x+3,e.y+3,f*1.05,f*.8,0,0,Math.PI*2),t.fill());const w=H[e.weapon]??H.usp,k=e.angle+.15,T=e.x+Math.cos(k)*f*.5,A=e.y+Math.sin(k)*f*.5,M=e.x+Math.cos(e.angle)*(f+w.len),I=e.y+Math.sin(e.angle)*(f+w.len);e.isAlive&&(t.strokeStyle=w.color,t.lineWidth=w.width/m,t.lineCap="round",t.beginPath(),t.moveTo(T,A),t.lineTo(M,I),t.stroke(),t.lineCap="butt",e.weapon&&(t.fillStyle="#333",t.beginPath(),t.arc(M,I,1.5/m,0,Math.PI*2),t.fill()));const X=e.isAlive?g?"#3b7dd8":"#d04040":"#3a3a3a",O=e.isAlive?g?"#2b5da8":"#a03030":"#2a2a2a";if(t.fillStyle=O,t.beginPath(),t.arc(e.x,e.y,f+1.5/m,0,Math.PI*2),t.fill(),t.fillStyle=X,t.beginPath(),t.arc(e.x,e.y,f,0,Math.PI*2),t.fill(),e.isAlive){const v=t.createRadialGradient(e.x-f*.3,e.y-f*.3,f*.1,e.x,e.y,f);v.addColorStop(0,"rgba(255,255,255,0.25)"),v.addColorStop(1,"rgba(255,255,255,0)"),t.fillStyle=v,t.beginPath(),t.arc(e.x,e.y,f,0,Math.PI*2),t.fill()}if(e.isLocal&&e.isAlive&&(t.strokeStyle="rgba(255,255,255,0.6)",t.lineWidth=1.5/m,t.beginPath(),t.arc(e.x,e.y,f+.5/m,0,Math.PI*2),t.stroke()),e.isAlive){const v=f*.7,L=e.x+Math.cos(e.angle)*(f*.5),R=e.y+Math.sin(e.angle)*(f*.5),D=L+Math.cos(e.angle)*v,E=R+Math.sin(e.angle)*v;t.strokeStyle="rgba(255,255,255,0.7)",t.lineWidth=2/m,t.beginPath(),t.moveTo(L,R),t.lineTo(D,E),t.stroke()}if(e.isAlive&&e.health<100){const v=f*2.2,L=3,R=e.x-v/2,D=e.y-f-10;t.fillStyle="rgba(0,0,0,0.5)",t.fillRect(R,D,v,L);const E=Math.max(0,e.health/100),j=E>.5?"#4caf50":E>.25?"#ff9800":"#f44336";t.fillStyle=j,t.fillRect(R,D,v*E,L)}if(e.isAlive&&(t.fillStyle=g?"rgba(120,180,255,0.85)":"rgba(255,130,130,0.85)",t.font="bold 9px sans-serif",t.textAlign="center",t.textBaseline="bottom",t.fillText(e.username,e.x,e.y-f-12)),!e.isAlive){t.strokeStyle="#666",t.lineWidth=2/m;const v=f*.5;t.beginPath(),t.moveTo(e.x-v,e.y-v),t.lineTo(e.x+v,e.y+v),t.moveTo(e.x+v,e.y-v),t.lineTo(e.x-v,e.y+v),t.stroke()}}),t.restore()}isVisible(t,s,i,o){const n=i-t,a=o-s;return n*n+a*a<=_*_}start(){this.resize(),this.lastTime=performance.now(),this.rafId=requestAnimationFrame(t=>this.tick(t))}stop(){var t;this.rafId!==null&&(cancelAnimationFrame(this.rafId),this.rafId=null),(t=this.cleanupInput)==null||t.call(this)}}const ut={class:"hud"},mt={class:"hud-top"},ft={class:"score"},yt={class:"team-ct"},wt={class:"team-t"},pt={key:0,class:"credits-bar"},vt={key:1,class:"round-info"},St={key:0,class:"round-timer"},gt={class:"hud-bottom"},xt={class:"hud-left"},bt={class:"hp-bar"},kt={class:"hp-text"},Mt={class:"weapon-slots"},It={class:"slot-key"},Rt={key:1,class:"slot-icon-empty"},Pt={class:"weapon-info"},Tt={class:"weapon-name"},At={class:"ammo"},Lt={class:"hud-right"},Ct={class:"stats"},Et={class:"stat"},Wt={class:"stat"},_t=N({__name:"GameHUD",props:{health:{},weapon:{},ammo:{},ammoReserve:{},kills:{},deaths:{},scoreCt:{},scoreT:{},credits:{},weapons:{},currentSlot:{},round:{},roundTimeLeft:{}},setup(l){var c,m;const t=l,s={usp:"USP-S",ak47:"AK-47",m4:"M4A1"},i={usp:20,ak47:28,m4:26},o=[{key:0,label:"1",weapon:((c=t.weapons)==null?void 0:c[0])??null},{key:1,label:"2",weapon:((m=t.weapons)==null?void 0:m[1])??"usp"}];function n(d){var y;return((y=t.weapons)==null?void 0:y[d])??null}function a(d){return(t.currentSlot??1)===d}return(d,p)=>(b(),P("div",ut,[u("div",mt,[u("div",ft,[u("span",yt,S(l.scoreCt),1),p[0]||(p[0]=u("span",{class:"sep"},":",-1)),u("span",wt,S(l.scoreT),1)]),l.credits!=null?(b(),P("div",pt," $"+S(l.credits),1)):Y("",!0),l.round!=null?(b(),P("div",vt,[u("span",null,"Раунд "+S(l.round),1),l.roundTimeLeft!=null?(b(),P("span",St,S(Math.floor((l.roundTimeLeft??0)/60))+":"+S(String((l.roundTimeLeft??0)%60).padStart(2,"0")),1)):Y("",!0)])):Y("",!0)]),u("div",gt,[u("div",xt,[u("div",bt,[u("div",{class:"hp-fill",style:U({width:`${l.health}%`})},null,4),u("span",kt,S(l.health)+" HP",1)]),u("div",Mt,[(b(),P(V,null,q(o,y=>u("div",{key:y.key,class:z(["weapon-slot",{selected:a(y.key),empty:!n(y.key)}])},[u("span",It,S(y.label),1),n(y.key)?(b(),P("span",{key:0,class:"slot-icon-bar",style:U({width:(i[n(y.key)]??18)+"px"})},null,4)):(b(),P("span",Rt,"—"))],2)),64))]),u("div",Pt,[u("span",Tt,[u("span",{class:"weapon-icon-bar",style:U({width:(i[l.weapon]??18)+"px"})},null,4),et(" "+S(s[l.weapon]??l.weapon),1)]),u("span",At,S(l.ammo)+" / "+S(l.ammoReserve),1)])]),u("div",Lt,[u("div",Ct,[u("span",Et,"K: "+S(l.kills),1),u("span",Wt,"D: "+S(l.deaths),1)])])])]))}}),qt=Z(_t,[["__scopeId","data-v-488d9190"]]),Dt={class:"shop-modal"},Yt={class:"shop-header"},Xt={class:"credits"},Ot={class:"shop-items"},Ut={class:"item-name"},Bt={class:"item-price"},$t=["disabled","onClick"],Kt=N({__name:"ShopModal",props:{show:{type:Boolean},credits:{},weapons:{}},emits:["close","buy"],setup(l,{emit:t}){const s=t,i=[{id:"ak47",name:"AK-47",price:2700,slot:0},{id:"m4",name:"M4A1",price:3100,slot:0}];return(o,n)=>(b(),st(nt,{to:"body"},[l.show?(b(),P("div",{key:0,class:"shop-overlay",onClick:n[0]||(n[0]=at(a=>s("close"),["self"]))},[u("div",Dt,[u("div",Yt,[n[1]||(n[1]=u("h3",null,"Магазин",-1)),u("span",Xt,"$"+S(l.credits),1)]),u("div",Ot,[(b(),P(V,null,q(i,a=>u("div",{key:a.id,class:z(["shop-item",{disabled:l.credits<a.price||l.weapons[0]}])},[u("div",Ut,S(a.name),1),u("div",Bt,"$"+S(a.price),1),u("button",{class:"btn-buy",disabled:l.credits<a.price||!!l.weapons[0],onClick:c=>s("buy",a.id)},S(l.weapons[0]?"Куплено":l.credits<a.price?"Недостаточно":"Купить"),9,$t)],2)),64))]),n[2]||(n[2]=u("p",{class:"shop-hint"},"B — закрыть",-1))])])):Y("",!0)]))}}),zt=Z(Kt,[["__scopeId","data-v-28544890"]]);export{qt as G,zt as S,Nt as a,Vt as b,rt as u};
