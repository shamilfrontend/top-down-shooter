var O=Object.defineProperty;var z=(c,e,t)=>e in c?O(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t;var w=(c,e,t)=>z(c,typeof e!="symbol"?e+"":e,t);import{d as B,p as C,q as N,n as L,c as U,a as T,f as k,z as G,A as K,m as I,B as b,o as $,_ as j}from"./index-BjcpxiQA.js";import{u as q}from"./MapRenderer-7N1qoh_1.js";import{u as V,a as Y,G as F,S as H,b as X}from"./ShopModal-CAlRZnEr.js";const Z=300,J=3250,Q=1400,E=800,S={usp:{id:"usp",name:"USP-S",damage:35,magazineSize:12,fireRateMs:150,reloadTimeMs:2200,range:600,spread:.02},ak47:{id:"ak47",name:"AK-47",damage:36,magazineSize:30,fireRateMs:100,reloadTimeMs:2500,range:690,spread:.04,price:2700},m4:{id:"m4",name:"M4A1",damage:33,magazineSize:30,fireRateMs:90,reloadTimeMs:3100,range:690,spread:.03,price:3100}},tt={ct:"usp"};function et(c,e,t,n,o,s,r,l){const i=(c-t)*(s-l)-(e-n)*(o-r);if(Math.abs(i)<1e-10)return null;const a=((c-o)*(s-l)-(e-s)*(o-r))/i,p=-((c-t)*(e-s)-(e-n)*(c-o))/i;return a>=0&&a<=1&&p>=0&&p<=1?{x:c+a*(t-c),y:e+a*(n-e),t:a}:null}function st(c,e,t,n,o,s){const r=o-t,l=s-n,i=r*r+l*l;if(i===0)return{dist:Math.hypot(c-t,e-n),t:0};let a=((c-t)*r+(e-n)*l)/i;a=Math.max(0,Math.min(1,a));const p=t+a*r,y=n+a*l;return{dist:Math.hypot(c-p,e-y),t:a}}function nt(c,e,t,n,o,s){const r=c+t*o,l=e+n*o;let i=1;for(const a of s){const p=[[a.x,a.y,a.x+a.width,a.y],[a.x+a.width,a.y,a.x+a.width,a.y+a.height],[a.x+a.width,a.y+a.height,a.x,a.y+a.height],[a.x,a.y+a.height,a.x,a.y]];for(const[y,f,h,u]of p){const d=et(c,e,r,l,y,f,h,u);d&&d.t<i&&(i=d.t)}}return i*o}function at(c,e,t,n,o,s,r,l){const i=(Math.random()-.5)*o*Math.PI,a=Math.cos(t+i),p=Math.sin(t+i),y=nt(c,e,a,p,n,s);let f=null;const h=c+a*n,u=e+p*n;for(const d of r){if(d.id===l)continue;const{dist:v,t:m}=st(d.x,d.y,c,e,h,u);if(v>d.radius)continue;const M=m*n-Math.sqrt(Math.max(0,d.radius*d.radius-v*v));M<0||M>y||(!f||M<f.dist)&&(f={hitId:d.id,dist:M})}return f}const _=25,ot=3e4,it=45e3,rt=1;function lt(c,e,t,n=40){for(const o of t){const s=o.x-n,r=o.y-n,l=o.width+n*2,i=o.height+n*2;if(c>=s&&c<=s+l&&e>=r&&e<=r+i)return!0}return!1}function ct(c,e,t){for(let n=0;n<50;n++){const o=80+Math.random()*(c-160),s=80+Math.random()*(e-160);if(!lt(o,s,t))return{x:o,y:s}}return{x:c/2,y:e/2}}function mt(c,e){const t=[],n=new Set,o=s=>{const r=ct(c.width,c.height,c.walls),l=`${Math.floor(r.x/50)}_${Math.floor(r.y/50)}`;n.has(l)||(n.add(l),t.push({id:`pickup_${t.length}`,type:s,x:r.x,y:r.y,respawnAt:0}))};for(let s=0;s<e.ammo;s++)o("ammo");for(let s=0;s<e.medkit;s++)o("medkit");return t}function ht(c,e,t,n){var o;for(const s of c)if(!(s.respawnAt>n))for(const r of e){if(!r.isAlive)continue;const l=r.x-s.x,i=r.y-s.y;if(!(l*l+i*i>_*_)){if(s.type==="ammo"){const a=t(r.weapon)??30;r.ammoReserve+=a*rt,(o=r.weaponAmmo)!=null&&o[r.weapon]&&(r.weaponAmmo[r.weapon].reserve=r.ammoReserve)}else s.type==="medkit"&&(r.health=Math.min(100,r.health+20));s.respawnAt=n+(s.type==="ammo"?ot:it);break}}}function ut(c,e){return c.filter(t=>t.respawnAt<=e).map(t=>({id:t.id,type:t.type,x:t.x,y:t.y}))}const P=["Bot Ivan","Bot Dmitry","Bot Alex","Bot Sergei"];function dt(c){return P[c%P.length]}function ft(c,e,t,n,o,s=2e3){const r=t-c,l=n-e,i=Math.hypot(r,l);if(i>s)return!1;const a=i>0?r/i:0,p=i>0?l/i:0,y=c+a*i,f=e+p*i;for(const h of o){const u=[[h.x,h.y,h.x+h.width,h.y],[h.x+h.width,h.y,h.x+h.width,h.y+h.height],[h.x+h.width,h.y+h.height,h.x,h.y+h.height],[h.x,h.y+h.height,h.x,h.y]];for(const[d,v,m,g]of u){const M=(c-y)*(v-g)-(e-f)*(d-m);if(Math.abs(M)<1e-10)continue;const A=((d-c)*(v-g)-(v-e)*(d-m))/M,x=-((c-y)*(v-e)-(e-f)*(d-c))/M;if(A>=0&&A<=1&&x>=0&&x<=1)return!1}}return!0}function pt(c,e){let t=e-c;for(;t>Math.PI;)t-=2*Math.PI;for(;t<-Math.PI;)t+=2*Math.PI;return t}function yt(c,e,t,n,o,s,r,l){const i=s.filter(m=>m.team!==e&&m.isAlive),a=.6,p=.15,y=.5;let f=null,h=1/0;for(const m of i){const g=Math.hypot(m.x-t,m.y-n);g<h&&ft(t,n,m.x,m.y,r)&&(h=g,f=m)}const u={up:!1,down:!1,left:!1,right:!1};let d=o,v=!1;if(f&&Math.random()<a){const m=Math.atan2(f.y-n,f.x-t),g=(Math.random()-.5)*2*p*Math.PI;if(d=m+g,Math.abs(pt(o,d))<.15&&(v=!0),h>250&&Math.random()<y){const A=m,x=Math.cos(A),R=Math.sin(A);x>.3?u.right=!0:x<-.3&&(u.left=!0),R>.3?u.down=!0:R<-.3&&(u.up=!0)}else if(h<150&&Math.random()<.5){const A=Math.atan2(n-f.y,t-f.x),x=Math.cos(A),R=Math.sin(A);x>.3?u.right=!0:x<-.3&&(u.left=!0),R>.3?u.down=!0:R<-.3&&(u.up=!0)}}else if(l%60<30&&Math.random()<.1){const m=Math.floor(Math.random()*4);m===0?u.up=!0:m===1?u.down=!0:m===2?u.left=!0:u.right=!0}return{input:u,angle:d,shoot:v}}const W=20,vt=1e3/W,wt=23,D=180*1e3,Mt=5e3,gt=2;class At{constructor(e){w(this,"map");w(this,"players",new Map);w(this,"pickups",[]);w(this,"tickInterval",null);w(this,"tickCount",0);w(this,"round",1);w(this,"roundStartTime",0);w(this,"roundWins",{ct:0,t:0});w(this,"roundPhase","playing");w(this,"roundEndAt",0);w(this,"onState");w(this,"onShotTrail");w(this,"onShot");w(this,"onRoundEnd");this.map=e}start(){const e={ct:[...this.map.spawnPoints.ct],t:[...this.map.spawnPoints.t]};let t=0,n=0;const o=tt.ct,s=S[o],r=e.ct[0]||{x:100,y:100};this.players.set("local",{id:"local",team:"ct",username:"You",x:r.x+30,y:r.y+30,angle:0,vx:0,vy:0,health:100,weapon:o,ammo:s.magazineSize,ammoReserve:24,isAlive:!0,kills:0,deaths:0,credits:E,weapons:[null,o],currentSlot:1,weaponAmmo:{},lastInput:{up:!1,down:!1,left:!1,right:!1},lastShotTime:0,reloadEndTime:0});for(let l=0;l<gt;l++){const i=l===0?"t":"ct",a=i==="ct"?e.ct:e.t,p=i==="ct"?t++:n++,y=a[p%a.length]||{x:100,y:100},f=`bot-${l}`,h=S[o];this.players.set(f,{id:f,team:i,username:dt(l),x:y.x+30,y:y.y+30,angle:0,vx:0,vy:0,health:100,weapon:o,ammo:h.magazineSize,ammoReserve:24,isAlive:!0,kills:0,deaths:0,credits:E,weapons:[null,o],currentSlot:1,weaponAmmo:{},lastInput:{up:!1,down:!1,left:!1,right:!1},lastShotTime:0,reloadEndTime:0})}this.pickups=mt(this.map,{ammo:5,medkit:3}),this.roundStartTime=Date.now(),this.tickInterval=setInterval(()=>this.tick(),vt)}setOnState(e){this.onState=e}setOnShotTrail(e){this.onShotTrail=e}setOnShot(e){this.onShot=e}setOnRoundEnd(e){this.onRoundEnd=e}setInput(e,t){const n=this.players.get(e);n&&(n.lastInput=t)}setAngle(e,t){const n=this.players.get(e);n&&(n.angle=t)}shoot(e){var f,h;const t=this.players.get(e);if(!t||!t.isAlive)return;const n=Date.now(),o=S[t.weapon];if(!o||t.reloadEndTime>n)return;if(t.ammo<=0){this.startReload(t);return}if(n-t.lastShotTime<o.fireRateMs)return;t.lastShotTime=n,t.ammo--,t.weaponAmmo[t.weapon]={ammo:t.ammo,reserve:t.ammoReserve};const s=(Math.random()-.5)*o.spread*Math.PI,r=t.angle+s,l=Array.from(this.players.values()).filter(u=>u.isAlive).map(u=>({id:u.id,team:u.team,x:u.x,y:u.y,radius:wt})),i=at(t.x,t.y,r,o.range,0,this.map.walls,l,e),a=i?i.dist:o.range,p=t.x+Math.cos(r)*a,y=t.y+Math.sin(r)*a;if((f=this.onShotTrail)==null||f.call(this,t.x,t.y,p,y),(h=this.onShot)==null||h.call(this,t.weapon),i){const u=this.players.get(i.hitId);u&&u.team!==t.team&&(u.health=Math.max(0,u.health-o.damage),u.health<=0&&(u.isAlive=!1,u.deaths++,t.kills++,t.credits+=Z))}}reload(e){const t=this.players.get(e);if(!t||!t.isAlive||t.ammoReserve<=0)return;const n=S[t.weapon];!n||t.ammo>=n.magazineSize||Date.now()<t.reloadEndTime||this.startReload(t)}startReload(e){const t=S[e.weapon];!t||t.reloadTimeMs<=0||(e.reloadEndTime=Date.now()+t.reloadTimeMs)}switchWeapon(e,t){const n=this.players.get(e);!n||!n.isAlive||!n.weapons[t]&&t===0||t!==n.currentSlot&&(n.weaponAmmo[n.weapon]={ammo:n.ammo,reserve:n.ammoReserve},n.currentSlot=t,this.applyWeaponSlot(n))}buyWeapon(e,t){const n=this.players.get(e);if(!n||!n.isAlive)return;const o=S[t];if(!(!o||!o.price)&&!(n.credits<o.price)&&(t==="ak47"||t==="m4")){if(n.weapons[0])return;n.credits-=o.price,n.weapons[0]=t,n.weaponAmmo[t]={ammo:o.magazineSize,reserve:90},n.weaponAmmo[n.weapon]={ammo:n.ammo,reserve:n.ammoReserve},n.currentSlot=0,this.applyWeaponSlot(n)}}applyWeaponSlot(e){const t=e.weapons[e.currentSlot];e.weapon=t??e.weapons[1];const n=S[e.weapon];if(!n)return;const o=e.weaponAmmo[e.weapon];o?(e.ammo=o.ammo,e.ammoReserve=o.reserve):(e.ammo=n.magazineSize,e.ammoReserve=e.weapon==="usp"?24:90)}respawnAll(){const e={ct:[...this.map.spawnPoints.ct],t:[...this.map.spawnPoints.t]};let t=0,n=0;for(const o of this.players.values()){const s=o.team==="ct"?e.ct:e.t,r=o.team==="ct"?t++:n++,l=s[r%s.length]||{x:100,y:100};o.x=l.x+30,o.y=l.y+30,o.vx=0,o.vy=0,o.health=100,o.isAlive=!0,o.reloadEndTime=0,this.applyWeaponSlot(o)}}checkRoundEnd(e){var r;if(this.roundPhase==="ended"){e>=this.roundEndAt&&(this.round++,this.roundPhase="playing",this.roundStartTime=e,this.respawnAll());return}const t=Array.from(this.players.values()).filter(l=>l.team==="ct"&&l.isAlive).length,n=Array.from(this.players.values()).filter(l=>l.team==="t"&&l.isAlive).length,o=Math.max(0,Math.floor((this.roundStartTime+D-e)/1e3));let s=null;if(n===0&&t>0?s="ct":t===0&&n>0?s="t":o<=0&&(s=t>n?"ct":n>t?"t":null),s){s==="ct"?this.roundWins.ct++:this.roundWins.t++,this.roundPhase="ended",this.roundEndAt=e+Mt,(r=this.onRoundEnd)==null||r.call(this,s);for(const l of this.players.values())l.credits+=l.team===s?J:Q}}processReloads(){const e=Date.now();for(const t of this.players.values())if(t.reloadEndTime>0&&e>=t.reloadEndTime){const n=S[t.weapon];if(n){const o=n.magazineSize-t.ammo,s=Math.min(o,t.ammoReserve);t.ammo+=s,t.ammoReserve-=s,t.weaponAmmo[t.weapon]={ammo:t.ammo,reserve:t.ammoReserve}}t.reloadEndTime=0}}tick(){var o;const e=1/W,t=Date.now();this.checkRoundEnd(t);for(const s of this.players.values())if(s.id.startsWith("bot-")&&s.isAlive){const r=Array.from(this.players.values()).map(i=>({id:i.id,team:i.team,x:i.x,y:i.y,isAlive:i.isAlive})),l=yt(s.id,s.team,s.x,s.y,s.angle,r,this.map.walls,this.tickCount);s.lastInput=l.input,s.angle=l.angle,l.shoot&&this.shoot(s.id)}this.processReloads(),ht(this.pickups,Array.from(this.players.values()),s=>{var r;return((r=S[s])==null?void 0:r.magazineSize)??30},t);for(const s of this.players.values()){if(!s.isAlive)continue;const r={x:s.x,y:s.y,vx:s.vx,vy:s.vy,angle:s.angle},l=V(r,s.lastInput,this.map,e);s.x=l.x,s.y=l.y,s.vx=l.vx,s.vy=l.vy}this.tickCount++;const n=this.roundPhase==="playing"?Math.max(0,Math.floor((this.roundStartTime+D-t)/1e3)):Math.max(0,Math.floor((this.roundEndAt-t)/1e3));(o=this.onState)==null||o.call(this,{players:Array.from(this.players.values()).map(s=>({id:s.id,x:s.x,y:s.y,angle:s.angle,team:s.team,username:s.username,health:s.health,weapon:s.weapon,ammo:s.ammo,ammoReserve:s.ammoReserve,isAlive:s.isAlive,kills:s.kills,deaths:s.deaths,credits:s.credits,weapons:s.weapons,currentSlot:s.currentSlot})),pickups:ut(this.pickups,t),round:this.round,roundTimeLeft:n,roundWins:{...this.roundWins},roundPhase:this.roundPhase})}stop(){this.tickInterval&&(clearInterval(this.tickInterval),this.tickInterval=null)}}const St={class:"game-view"},xt={class:"game-canvas-wrap"},Rt=B({__name:"GameView",setup(c){const e=b(),{fetchMap:t}=q(),{playShot:n,playReload:o,playWinCt:s,playWinTer:r}=Y(),l=I(null);let i=null,a=null;const p=I({health:100,weapon:"usp",ammo:12,ammoReserve:24,kills:0,deaths:0,scoreCt:0,scoreT:0,credits:800,weapons:[null,"usp"],currentSlot:1,round:1,roundTimeLeft:180}),y=I(!1);async function f(){const u=e.params.mapId||"dust2",d=l.value;if(d)try{const v=await t(u);a=new At(v),i=new X({canvas:d,map:v,localPlayerId:"local",networked:!0,onInput:m=>{a==null||a.setInput("local",{up:m.up??!1,down:m.down??!1,left:m.left??!1,right:m.right??!1}),a==null||a.setAngle("local",m.angle)},onShoot:()=>a==null?void 0:a.shoot("local"),onReload:()=>{a==null||a.reload("local"),o()},onSwitchWeapon:m=>a==null?void 0:a.switchWeapon("local",m),onOpenShop:()=>{y.value=!y.value},onHUDUpdate:m=>{p.value=m}}),a.setOnState(m=>{i==null||i.setServerState(m.players,m.pickups,{round:m.round,roundTimeLeft:m.roundTimeLeft,roundWins:m.roundWins})}),a.setOnShotTrail((m,g,M,A)=>{i==null||i.addBulletTrail(m,g,M,A)}),a.setOnShot(m=>n(m)),a.setOnRoundEnd(m=>{m==="ct"?s():r()}),a.start(),i.setFogOfWar(!0),i.start()}catch(v){console.error("Failed to load map:",v)}}function h(u){a==null||a.buyWeapon("local",u),y.value=!1}return C(f),N(()=>{a==null||a.stop(),a=null,i==null||i.stop(),i=null}),L(()=>e.params.mapId,()=>{a==null||a.stop(),a=null,i==null||i.stop(),f()}),(u,d)=>($(),U("div",St,[d[1]||(d[1]=T("div",{class:"game-header"},[T("h2",null,"Игра (одиночный режим)"),T("p",{class:"hint"},"WASD — движение, мышь — прицел, ЛКМ — стрельба, R — перезарядка, 1/2 — оружие, B — магазин")],-1)),T("div",xt,[T("canvas",{ref_key:"canvasRef",ref:l,class:"game-canvas"},null,512),k(F,G(K(p.value)),null,16),k(H,{show:y.value,credits:p.value.credits,weapons:p.value.weapons,onClose:d[0]||(d[0]=v=>y.value=!1),onBuy:h},null,8,["show","credits","weapons"])])]))}}),_t=j(Rt,[["__scopeId","data-v-9954ac10"]]);export{_t as default};
